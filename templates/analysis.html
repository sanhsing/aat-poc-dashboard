<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·±åº¦åˆ†æ | AAT PoC</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .header { text-align: center; padding: 20px 0 15px; }
        .header h1 { font-size: 1.8em; margin-bottom: 5px; }
        .header p { color: #888; font-size: 0.9em; }
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        .nav-tabs a {
            color: #888;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        .nav-tabs a:hover { color: #fff; background: rgba(255,255,255,0.1); }
        .nav-tabs a.active { color: #fff; background: #4472C4; }
        .container { max-width: 1600px; margin: 0 auto; }
        
        /* æ§åˆ¶åˆ— */
        .control-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 12px 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            flex-wrap: wrap;
            gap: 15px;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filter-group label {
            color: #888;
            font-size: 0.85em;
        }
        .filter-group select {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
        }
        .filter-group select:focus {
            outline: none;
            border-color: #4472C4;
        }
        .filter-group select option {
            background: #1a1a2e;
            color: #fff;
        }
        .export-group {
            display: flex;
            gap: 10px;
        }
        .export-btn {
            background: linear-gradient(135deg, #4472C4, #2955a8);
            border: none;
            color: #fff;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s;
        }
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(68, 114, 196, 0.4);
        }
        
        /* Loading å‹•ç•« */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #888;
        }
        .loading::after {
            content: '';
            width: 30px;
            height: 30px;
            border: 3px solid rgba(68, 114, 196, 0.2);
            border-top-color: #4472C4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ç•°å¸¸é«˜äº® */
        .highlight-danger {
            animation: pulse-danger 2s infinite;
        }
        @keyframes pulse-danger {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
        }
        .trend-up { color: #dc3545; }
        .trend-up::before { content: 'â†‘ '; }
        .trend-down { color: #28a745; }
        .trend-down::before { content: 'â†“ '; }
        .trend-stable { color: #888; }
        .trend-stable::before { content: 'â†’ '; }
        
        /* åˆ—å°æ¨£å¼ */
        @media print {
            body { background: white; color: black; }
            .nav-tabs, .control-bar, .tab-nav, .export-btn { display: none; }
            .tab-content { display: block !important; page-break-after: always; }
            .card { border: 1px solid #ddd; }
            .recommendation-box { border: 2px solid #28a745; }
            .action-summary { border: 2px solid #ffc107; }
        }
        
        /* Tab åˆ‡æ› */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .tab-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: #888;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .tab-btn.active { background: #4472C4; color: #fff; border-color: #4472C4; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* é€šç”¨å¡ç‰‡ */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px; }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card h3 {
            font-size: 0.95em;
            color: #888;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card h3::before {
            content: '';
            width: 3px;
            height: 14px;
            background: #4472C4;
            border-radius: 2px;
        }
        .chart-container { position: relative; height: 250px; }
        
        /* çµ±è¨ˆå¡ç‰‡ */
        .stat-card {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .stat-card .value { font-size: 1.6em; font-weight: bold; color: #4472C4; }
        .stat-card .label { color: #888; font-size: 0.8em; margin-top: 3px; }
        .stat-card.alert .value { color: #dc3545; }
        .stat-card.warning .value { color: #ffc107; }
        .stat-card.success .value { color: #28a745; }
        
        /* è­¦ç¤ºå¡ç‰‡ */
        .alert-card {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .alert-card.warning {
            background: rgba(255, 193, 7, 0.1);
            border-color: rgba(255, 193, 7, 0.3);
        }
        .alert-card .machine { font-weight: bold; font-size: 1.1em; }
        .alert-card .detail { color: #888; font-size: 0.85em; margin-top: 5px; }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: bold;
        }
        .badge-critical { background: #dc3545; color: #fff; }
        .badge-high { background: #fd7e14; color: #fff; }
        .badge-medium { background: #ffc107; color: #000; }
        .badge-low { background: #28a745; color: #fff; }
        
        /* è¡¨æ ¼ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }
        .data-table th, .data-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .data-table th { color: #888; font-weight: normal; font-size: 0.85em; }
        .data-table tr:hover td { background: rgba(255,255,255,0.03); }
        
        /* è©•åˆ†å¡ */
        .score-card {
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .score-card .info { flex: 1; }
        .score-card .name { font-weight: bold; font-size: 1.1em; }
        .score-card .metrics { color: #888; font-size: 0.85em; margin-top: 5px; }
        .score-card .grade {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
        }
        .grade-A { background: #28a745; color: #fff; }
        .grade-B { background: #4472C4; color: #fff; }
        .grade-C { background: #ffc107; color: #000; }
        .grade-D { background: #dc3545; color: #fff; }
        
        /* æ´è¦‹æ¡† */
        .insight-box {
            background: linear-gradient(135deg, rgba(68, 114, 196, 0.2), rgba(68, 114, 196, 0.1));
            border: 1px solid rgba(68, 114, 196, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        .insight-box .icon { font-size: 1.2em; margin-right: 10px; }
        .insight-box .text { color: #aaa; font-size: 0.9em; }
        
        /* ä¼æ¥­å»ºè­°æ¡† */
        .recommendation-box {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05));
            border: 1px solid rgba(40, 167, 69, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        .rec-header {
            font-size: 1.1em;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(40, 167, 69, 0.2);
        }
        .rec-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        .rec-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 12px 15px;
            border-left: 3px solid #4472C4;
            font-size: 0.9em;
            line-height: 1.6;
            color: #ccc;
        }
        .rec-item.critical {
            border-left-color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }
        .rec-item.success {
            border-left-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }
        .rec-tag {
            display: inline-block;
            background: rgba(68, 114, 196, 0.3);
            color: #7eb3ff;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .rec-item.critical .rec-tag {
            background: rgba(220, 53, 69, 0.3);
            color: #ff8a8a;
        }
        .rec-item.success .rec-tag {
            background: rgba(40, 167, 69, 0.3);
            color: #8aff8a;
        }
        .rec-item strong {
            color: #fff;
        }
        
        /* ç¸½çµè¡Œå‹•æ¸…å–® */
        .action-summary {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.05));
            border: 2px solid rgba(255, 193, 7, 0.3);
            border-radius: 16px;
            padding: 25px;
            margin-top: 30px;
        }
        .summary-header {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffc107;
            margin-bottom: 20px;
            text-align: center;
        }
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .action-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s;
        }
        .action-item:hover {
            transform: translateY(-3px);
        }
        .action-item.priority-1 {
            border-color: rgba(220, 53, 69, 0.5);
            background: rgba(220, 53, 69, 0.1);
        }
        .action-item.priority-2 {
            border-color: rgba(253, 126, 20, 0.5);
            background: rgba(253, 126, 20, 0.1);
        }
        .action-item.priority-3 {
            border-color: rgba(40, 167, 69, 0.5);
            background: rgba(40, 167, 69, 0.1);
        }
        .priority-badge {
            font-size: 0.85em;
            margin-bottom: 8px;
        }
        .action-title {
            font-weight: bold;
            font-size: 1em;
            color: #fff;
            margin-bottom: 5px;
        }
        .action-desc {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 8px;
        }
        .action-benefit {
            font-size: 0.9em;
            font-weight: bold;
            color: #28a745;
        }
        .summary-footer {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px 20px;
            text-align: center;
            color: #ccc;
            font-size: 0.95em;
            line-height: 1.6;
        }
        .summary-footer strong {
            color: #ffc107;
        }
        
        @media (max-width: 1200px) {
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
            .grid-3 { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
            .tab-nav { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ˆ æ·±åº¦åˆ†æä¸­å¿ƒ</h1>
            <p>XTF æ¶ˆ-æ‹“-è | 60å¤© Ã— 108,000ç­† Ã— 7ç¶­åº¦åˆ†æ | @11æ˜Ÿå”ä½œ</p>
        </div>
        
        <div class="nav-tabs">
            <a href="/">ğŸ“Š Dashboard</a>
            <a href="/query">ğŸ’¬ æŸ¥è©¢</a>
            <a href="/aoi">ğŸ”¬ AOI</a>
            <a href="/analysis" class="active">ğŸ“ˆ åˆ†æ</a>
        </div>
        
        <!-- æ§åˆ¶åˆ—ï¼šæ™‚é–“ç¯©é¸ + åŒ¯å‡º -->
        <div class="control-bar">
            <div class="filter-group">
                <label>ğŸ“… æ™‚é–“ç¯„åœ</label>
                <select id="dateRange" onchange="applyDateFilter()">
                    <option value="7">æœ€è¿‘ 7 å¤©</option>
                    <option value="14">æœ€è¿‘ 14 å¤©</option>
                    <option value="30" selected>æœ€è¿‘ 30 å¤©</option>
                    <option value="60">å…¨éƒ¨ 60 å¤©</option>
                </select>
            </div>
            <div class="filter-group">
                <label>ğŸ­ ç”¢ç·š</label>
                <select id="lineFilter" onchange="applyLineFilter()">
                    <option value="all">å…¨éƒ¨ç”¢ç·š</option>
                </select>
            </div>
            <div class="export-group">
                <button class="export-btn" onclick="exportPDF()">ğŸ“„ åŒ¯å‡º PDF</button>
                <button class="export-btn" onclick="exportExcel()">ğŸ“Š åŒ¯å‡º Excel</button>
            </div>
        </div>
        
        <!-- Tab å°èˆª -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="showTab('overview')">ğŸ“Š ç¸½è¦½</button>
            <button class="tab-btn" onclick="showTab('maintenance')">ğŸ”§ ç¶­è­·è­¦ç¤º</button>
            <button class="tab-btn" onclick="showTab('temperature')">ğŸŒ¡ï¸ æº«åº¦åˆ†æ</button>
            <button class="tab-btn" onclick="showTab('cost')">ğŸ’° æˆæœ¬æå¤±</button>
            <button class="tab-btn" onclick="showTab('supplier')">ğŸ­ ä¾›æ‡‰å•†</button>
            <button class="tab-btn" onclick="showTab('predictive')">ğŸ”® é æ¸¬ç¶­è­·</button>
            <button class="tab-btn" onclick="showTab('vibration')">ğŸ”Š æŒ¯å‹•</button>
            <button class="tab-btn" onclick="showTab('multifactor')">ğŸ¯ å¤šå› å­</button>
            <button class="tab-btn" onclick="showTab('timepattern')">â° æ™‚æ®µ</button>
            <button class="tab-btn" onclick="showTab('mainteffect')">ğŸ› ï¸ ç¶­è­·æ•ˆæœ</button>
            <button class="tab-btn" onclick="showTab('spc')">ğŸ“‰ SPC</button>
        </div>
        
        <!-- ç¸½è¦½ Tab -->
        <div id="tab-overview" class="tab-content active">
            <div class="grid-4" id="overviewStats"></div>
            <div class="grid-2">
                <div class="card">
                    <h3>è‰¯ç‡è¶¨å‹¢ï¼ˆæ—¥ç¶­åº¦ï¼‰</h3>
                    <div class="chart-container"><canvas id="yieldTrendChart"></canvas></div>
                </div>
                <div class="card">
                    <h3>ç”¢ç·šç¸¾æ•ˆæ¯”è¼ƒ</h3>
                    <div class="chart-container"><canvas id="linePerformanceChart"></canvas></div>
                </div>
            </div>
            <div class="grid-2">
                <div class="card">
                    <h3>ä¸è‰¯ç‡ç†±åŠ›åœ–ï¼ˆç”¢ç·šÃ—ç­æ¬¡ï¼‰</h3>
                    <div id="heatmapContainer"></div>
                </div>
                <div class="card">
                    <h3>æ“ä½œå“¡ Top 10</h3>
                    <table class="data-table" id="operatorTable">
                        <thead><tr><th>#</th><th>æ“ä½œå“¡</th><th>æ‰¹æ¬¡</th><th>è‰¯ç‡</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="recommendation-box">
                <div class="rec-header">ğŸ’¼ ä¼æ¥­ä¸»å»ºè­°</div>
                <div class="rec-content">
                    <div class="rec-item critical">
                        <span class="rec-tag">é—œéµç™¼ç¾</span>
                        è‰¯ç‡å¾ 98% è·Œè‡³ 80%ï¼Œééš¨æ©Ÿæ³¢å‹•ï¼Œæ˜¯<strong>ç³»çµ±æ€§å•é¡Œ</strong>
                    </div>
                    <div class="rec-item">
                        <span class="rec-tag">ç«‹å³èª¿æŸ¥</span>
                        1. é€™æ®µæ™‚é–“æœ‰ä»€éº¼è®ŠåŒ–ï¼Ÿï¼ˆåŸæ–™æ‰¹æ¬¡ï¼Ÿè¨­å‚™ï¼Ÿäººå“¡ï¼Ÿï¼‰<br>
                        2. æ˜¯å“ªæ¢ç·šå…ˆé–‹å§‹ä¸‹æ»‘ï¼Ÿæ‰¾å‡ºæºé ­
                    </div>
                    <div class="rec-item success">
                        <span class="rec-tag">è¡Œæ¥­æ¨™æº–</span>
                        è‰¯ç‡æ‡‰ >95%ï¼Œç›®å‰ 86% æœ‰ <strong>10% æ”¹å–„ç©ºé–“</strong>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç¶­è­·è­¦ç¤º Tab -->
        <div id="tab-maintenance" class="tab-content">
            <div class="grid-4" id="maintenanceStats"></div>
            <div class="grid-2">
                <div class="card">
                    <h3>é‹è¡Œæ™‚æ•¸ vs ä¸è‰¯ç‡</h3>
                    <div class="chart-container"><canvas id="runtimeChart"></canvas></div>
                </div>
                <div class="card">
                    <h3>âš ï¸ éœ€ç¶­è­·æ©Ÿå°</h3>
                    <div id="maintenanceAlerts"></div>
                </div>
            </div>
            <div class="insight-box">
                <span class="icon">ğŸ’¡</span>
                <span class="text" id="maintenanceInsight">è¼‰å…¥ä¸­...</span>
            </div>
            <div class="recommendation-box">
                <div class="rec-header">ğŸ’¼ ä¼æ¥­ä¸»å»ºè­°</div>
                <div class="rec-content">
                    <div class="rec-item critical">
                        <span class="rec-tag">ç¡¬é–€æª»</span>
                        <strong>300h = ç¶­è­·è‡¨ç•Œé»</strong>ï¼Œè¶…éæ­¤å€¼ä¸è‰¯ç‡æ€¥å‡ 10 å€
                    </div>
                    <div class="rec-item">
                        <span class="rec-tag">ç«‹å³è¡Œå‹•</span>
                        1. ç›¤é»æ‰€æœ‰æ©Ÿå°ç´¯è¨ˆé‹è¡Œæ™‚æ•¸<br>
                        2. >280h çš„æ©Ÿå°æ’é€²<strong>æœ¬é€±ç¶­è­·è¨ˆåŠƒ</strong><br>
                        3. å»ºç«‹ã€Œè¶…æ™‚å³åœã€åˆ¶åº¦
                    </div>
                    <div class="rec-item success">
                        <span class="rec-tag">é æœŸæ•ˆç›Š</span>
                        è½å¯¦ 300h ç¶­è­·åˆ¶åº¦ï¼Œ<strong>å¹´çœ Â¥500è¬</strong>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æº«åº¦åˆ†æ Tab -->
        <div id="tab-temperature" class="tab-content">
            <div class="grid-2">
                <div class="card">
                    <h3>æº«åº¦å€é–“ vs ä¸è‰¯ç‡</h3>
                    <div class="chart-container"><canvas id="tempRangeChart"></canvas></div>
                </div>
                <div class="card">
                    <h3>å„ç”¢ç·šæº«åº¦åˆ†ä½ˆ</h3>
                    <div class="chart-container"><canvas id="lineTempChart"></canvas></div>
                </div>
            </div>
            <div class="insight-box">
                <span class="icon">ğŸŒ¡ï¸</span>
                <span class="text" id="tempInsight">è¼‰å…¥ä¸­...</span>
            </div>
            <div class="recommendation-box">
                <div class="rec-header">ğŸ’¼ ä¼æ¥­ä¸»å»ºè­°</div>
                <div class="rec-content">
                    <div class="rec-item critical">
                        <span class="rec-tag">é—œéµç™¼ç¾</span>
                        æ‰€æœ‰ç”¢ç·šæº«åº¦ 68-70Â°Cï¼Œ<strong>å…¨éƒ¨è¶…éå®‰å…¨å€é–“ï¼ˆ<66Â°Cï¼‰</strong>
                    </div>
                    <div class="rec-item">
                        <span class="rec-tag">ç«‹å³è¡Œå‹•</span>
                        1. æª¢æŸ¥å†·å»æ°´æµé‡ã€é¢¨æ‰‡æ˜¯å¦æ­£å¸¸<br>
                        2. è©•ä¼°æ˜¯å¦éœ€è¦åŠ è£å†·å»è¨­å‚™<br>
                        3. æš«æ™‚é™ä½ç”¢ç·šé€Ÿåº¦ä»¥é™æº«
                    </div>
                    <div class="rec-item success">
                        <span class="rec-tag">æŠ•è³‡å›å ±</span>
                        æº«åº¦é™ 4Â°Cï¼ˆ68â†’64ï¼‰ï¼Œä¸è‰¯ç‡å¾ 10% é™åˆ° 4%<br>
                        <strong>å¹´çœç´„ Â¥1,000è¬</strong>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æˆæœ¬æå¤± Tab -->
        <div id="tab-cost" class="tab-content">
            <div class="grid-3" id="costStats"></div>
            <div class="grid-2">
                <div class="card">
                    <h3>å„ç”¢ç·šæå¤±</h3>
                    <div class="chart-container"><canvas id="lineLossChart"></canvas></div>
                </div>
                <div class="card">
                    <h3>å„ä¾›æ‡‰å•†é€ æˆæå¤±</h3>
                    <div class="chart-container"><canvas id="supplierLossChart"></canvas></div>
                </div>
            </div>
            <div class="insight-box">
                <span class="icon">ğŸ’°</span>
                <span class="text" id="costInsight">è¼‰å…¥ä¸­...</span>
            </div>
            <div class="recommendation-box">
                <div class="rec-header">ğŸ’¼ ä¼æ¥­ä¸»å»ºè­°</div>
                <div class="rec-content">
                    <div class="rec-item critical">
                        <span class="rec-tag">æ ¸å¿ƒè¨Šæ¯</span>
                        å¹´æ Â¥1,915è¬ <strong>æ˜¯å¯ä»¥æŒ½å›çš„éŒ¢</strong>ï¼Œä¸æ˜¯å›ºå®šæˆæœ¬
                    </div>
                    <div class="rec-item">
                        <span class="rec-tag">å„ªå…ˆè™•ç†</span>
                        1. <strong>L09 ç”¢ç·š</strong>ï¼šæå¤±æœ€é«˜ï¼Œèª¿æŸ¥æ ¹å› ï¼ˆè¨­å‚™è€èˆŠï¼Ÿäººå“¡ï¼Ÿï¼‰<br>
                        2. <strong>S06 ä¾›æ‡‰å•†</strong>ï¼šç«‹å³ç´„è«‡ï¼Œè¦æ±‚æ”¹å–„æˆ–æ¸›å°‘æ¡è³¼æ¯”ä¾‹
                    </div>
                    <div class="rec-item success">
                        <span class="rec-tag">æ”¹å–„ç›®æ¨™</span>
                        3 å€‹æœˆå…§å°‡å¹´åŒ–æå¤±é™è‡³ Â¥1,000è¬ä»¥ä¸‹<br>
                        <strong>å¹´çœ Â¥900è¬</strong>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ä¾›æ‡‰å•† Tab -->
        <div id="tab-supplier" class="tab-content">
            <div class="card">
                <h3>ä¾›æ‡‰å•†è©•åˆ†å¡ï¼ˆå“è³ª60% + æˆæœ¬20% + äº¤æœŸ20%ï¼‰</h3>
                <div id="supplierScorecards"></div>
            </div>
            <div class="insight-box">
                <span class="icon">ğŸ­</span>
                <span class="text" id="supplierInsight">è¼‰å…¥ä¸­...</span>
            </div>
            <div class="recommendation-box">
                <div class="rec-header">ğŸ’¼ ä¼æ¥­ä¸»å»ºè­°</div>
                <div class="rec-content">
                    <div class="rec-item critical">
                        <span class="rec-tag">æ·˜æ±°è­¦ç¤º</span>
                        <strong>S05 æ˜¯ D ç´š</strong>ï¼Œæ‡‰æ·˜æ±°æˆ–å¤§å¹…æ¸›å°‘æ¡è³¼
                    </div>
                    <div class="rec-item">
                        <span class="rec-tag">ç­–ç•¥èª¿æ•´</span>
                        1. <strong>S04 æå‡æ¡è³¼æ¯”ä¾‹</strong>ï¼ˆç›®å‰æœ€ä½³ B ç´šï¼‰<br>
                        2. S05/S06 ä¸‹å­£åº¦æ¸›å°‘ 30% è¨‚å–®<br>
                        3. çµ¦ S01 æå‡æ©Ÿæœƒï¼Œè‹¥é” B ç´šå‰‡å¢åŠ åˆä½œ
                    </div>
                    <div class="rec-item success">
                        <span class="rec-tag">è«‡åˆ¤ç±Œç¢¼</span>
                        æ‹¿é€™ä»½è©•åˆ†å¡å»è·Ÿä¾›æ‡‰å•†è«‡<br>
                        <strong>æœ‰æ•¸æ“šå°±æœ‰åº•æ°£</strong>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é æ¸¬ç¶­è­· Tab -->
        <div id="tab-predictive" class="tab-content">
            <div class="grid-4" id="predictiveStats"></div>
            <div class="card">
                <h3>æ©Ÿå°å¥åº·åº¦æ’åï¼ˆéœ€å„ªå…ˆé—œæ³¨ï¼‰</h3>
                <table class="data-table" id="healthTable">
                    <thead><tr><th>æ©Ÿå°</th><th>é‹è¡Œæ™‚æ•¸</th><th>æº«åº¦</th><th>æŒ¯å‹•</th><th>å¥åº·åˆ†</th><th>é¢¨éšª</th><th>å»ºè­°</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="insight-box">
                <span class="icon">ğŸ”®</span>
                <span class="text" id="predictiveInsight">è¼‰å…¥ä¸­...</span>
            </div>
            <div class="recommendation-box">
                <div class="rec-header">ğŸ’¼ ä¼æ¥­ä¸»å»ºè­°</div>
                <div class="rec-content">
                    <div class="rec-item">
                        <span class="rec-tag">å¥åº·åˆ†æ•¸</span>
                        é‹è¡Œæ™‚æ•¸ 50% + æº«åº¦ 30% + æŒ¯å‹• 20%<br>
                        <strong>åˆ†æ•¸è¶Šä½ = è¶Šéœ€è¦ç¶­è­·</strong>
                    </div>
                    <div class="rec-item">
                        <span class="rec-tag">é¢¨éšªç­‰ç´š</span>
                        ğŸ”´ CRITICAL (<30åˆ†)ï¼šç«‹å³ç¶­è­·<br>
                        ğŸŸ  HIGH (30-50åˆ†)ï¼šæ’ç¨‹ç¶­è­·<br>
                        ğŸŸ¡ MEDIUM (50-70åˆ†)ï¼šåŠ å¼·ç›£æ§<br>
                        ğŸŸ¢ LOW (>70åˆ†)ï¼šæ­£å¸¸é‹è¡Œ
                    </div>
                    <div class="rec-item success">
                        <span class="rec-tag">é é˜²å‹æ²»ç™‚</span>
                        é æ¸¬æ€§ç¶­è­·å¯é™ä½ <strong>70% éè¨ˆåŠƒåœæ©Ÿ</strong><br>
                        æ¯æ¬¡éè¨ˆåŠƒåœæ©Ÿæˆæœ¬ç´„ Â¥5-10è¬
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æŒ¯å‹•åˆ†æ Tab -->
        <div id="tab-vibration" class="tab-content">
            <div class="grid-4" id="vibrationStats"></div>
            <div class="grid-2">
                <div class="card">
                    <h3>æŒ¯å‹•å€é–“ vs ä¸è‰¯ç‡</h3>
                    <div class="chart-container"><canvas id="vibRangeChart"></canvas></div>
                </div>
                <div class="card">
                    <h3>æŒ¯å‹•è¶¨å‹¢ï¼ˆæ—¥ç¶­åº¦ï¼‰</h3>
                    <div class="chart-container"><canvas id="vibTrendChart"></canvas></div>
                </div>
            </div>
            <div class="card">
                <h3>âš ï¸ é«˜æŒ¯å‹•æ©Ÿå°ï¼ˆéœ€æª¢æŸ¥ï¼‰</h3>
                <table class="data-table" id="vibMachineTable">
                    <thead><tr><th>æ©Ÿå°</th><th>å¹³å‡æŒ¯å‹•</th><th>æœ€å¤§æŒ¯å‹•</th><th>ä¸è‰¯ç‡</th><th>ç‹€æ…‹</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="insight-box">
                <span class="icon">ğŸ”Š</span>
                <span class="text" id="vibrationInsight">è¼‰å…¥ä¸­...</span>
            </div>
            <div class="recommendation-box">
                <div class="rec-header">ğŸ’¼ ä¼æ¥­ä¸»å»ºè­°</div>
                <div class="rec-content">
                    <div class="rec-item critical">
                        <span class="rec-tag">éš±è—æ®ºæ‰‹</span>
                        æŒ¯å‹• >2.5 æ˜¯<strong>ä¸è‰¯ç‡é£†å‡çš„é—œéµæŒ‡æ¨™</strong>ï¼Œæ¯”æº«åº¦æ›´æ•æ„Ÿ
                    </div>
                    <div class="rec-item">
                        <span class="rec-tag">ç«‹å³è¡Œå‹•</span>
                        1. é«˜æŒ¯å‹•æ©Ÿå°å„ªå…ˆå®‰æ’<strong>è»¸æ‰¿æª¢æŸ¥</strong><br>
                        2. æª¢æŸ¥æ©Ÿå°å›ºå®šèºçµ²æ˜¯å¦é¬†å‹•<br>
                        3. è©•ä¼°æ˜¯å¦éœ€è¦å‹•å¹³è¡¡æ ¡æ­£
                    </div>
                    <div class="rec-item success">
                        <span class="rec-tag">é æœŸæ•ˆç›Š</span>
                        æŒ¯å‹•å¾ 3.0 é™åˆ° 2.0ï¼Œä¸è‰¯ç‡å¯é™ <strong>15%</strong><br>
                        <strong>å¹´çœç´„ Â¥800è¬</strong>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å¤šå› å­åˆ†æ Tab -->
        <div id="tab-multifactor" class="tab-content">
            <div class="grid-2">
                <div class="card">
                    <h3>ä¸‰å› å­äº¤äº’çŸ©é™£ï¼ˆæº«åº¦Ã—æ™‚æ•¸Ã—æŒ¯å‹•ï¼‰</h3>
                    <div id="factorMatrix"></div>
                </div>
                <div class="card">
                    <h3>æº«åº¦Ã—é‹è¡Œæ™‚æ•¸ ç†±åŠ›åœ–</h3>
                    <div id="factorHeatmap"></div>
                </div>
            </div>
            <div class="insight-box">
                <span class="icon">ğŸ¯</span>
                <span class="text" id="multifactorInsight">è¼‰å…¥ä¸­...</span>
            </div>
            <div class="recommendation-box">
                <div class="rec-header">ğŸ’¼ ä¼æ¥­ä¸»å»ºè­°</div>
                <div class="rec-content">
                    <div class="rec-item critical">
                        <span class="rec-tag">ç½é›£é…æ–¹</span>
                        <strong>é«˜æº« + é«˜æ™‚æ•¸ + é«˜æŒ¯å‹• = 19.86% ä¸è‰¯ç‡</strong><br>
                        æ˜¯æœ€ä½³çµ„åˆçš„ 12 å€ï¼
                    </div>
                    <div class="rec-item">
                        <span class="rec-tag">é è­¦æ©Ÿåˆ¶</span>
                        ç•¶ä»»æ„å…©å€‹å› å­åŒæ™‚è¶…æ¨™æ™‚ï¼Œ<strong>ç«‹å³åœæ©Ÿæª¢æŸ¥</strong><br>
                        ä¸è¦ç­‰ä¸‰å€‹éƒ½è¶…æ¨™æ‰è¡Œå‹•
                    </div>
                    <div class="rec-item success">
                        <span class="rec-tag">æ ¸å¿ƒè¨Šæ¯</span>
                        å–®ä¸€å› å­å¯å®¹å¿ï¼Œ<strong>çµ„åˆæ•ˆæ‡‰æ˜¯çœŸæ­£çš„é¢¨éšª</strong>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ™‚æ®µåˆ†æ Tab -->
        <div id="tab-timepattern" class="tab-content">
            <div class="grid-2">
                <div class="card">
                    <h3>24å°æ™‚ä¸è‰¯ç‡åˆ†ä½ˆ</h3>
                    <div class="chart-container"><canvas id="hourlyChart"></canvas></div>
                </div>
                <div class="card">
                    <h3>é€±é–“ä¸è‰¯ç‡åˆ†ä½ˆ</h3>
                    <div class="chart-container"><canvas id="weeklyChart"></canvas></div>
                </div>
            </div>
            <div class="card">
                <h3>ç­æ¬¡Ã—æ™‚æ®µ ç†±åŠ›åœ–</h3>
                <div id="shiftHourHeatmap"></div>
            </div>
            <div class="insight-box">
                <span class="icon">â°</span>
                <span class="text" id="timepatternInsight">è¼‰å…¥ä¸­...</span>
            </div>
            <div class="recommendation-box">
                <div class="rec-header">ğŸ’¼ ä¼æ¥­ä¸»å»ºè­°</div>
                <div class="rec-content">
                    <div class="rec-item critical">
                        <span class="rec-tag">æ™‚æ®µç™¼ç¾</span>
                        æ—©ç­ï¼ˆ5-9é»ï¼‰ä¸è‰¯ç‡æœ€é«˜ï¼Œå¯èƒ½èˆ‡<strong>äº¤æ¥ç­</strong>æœ‰é—œ
                    </div>
                    <div class="rec-item">
                        <span class="rec-tag">æ’ç­å„ªåŒ–</span>
                        1. å¼·åŒ–æ—©ç­äº¤æ¥æµç¨‹<br>
                        2. é€±äºŒåŠ å¼·å“è³ªç›£æ§<br>
                        3. è€ƒæ…®èª¿æ•´é‡è¦è¨‚å–®æ’ç¨‹
                    </div>
                    <div class="rec-item success">
                        <span class="rec-tag">é æœŸæ•ˆç›Š</span>
                        æ™‚æ®µå„ªåŒ–å¯æå‡æ•´é«”æ•ˆç‡ <strong>3-5%</strong>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç¶­è­·æ•ˆæœ Tab -->
        <div id="tab-mainteffect" class="tab-content">
            <div class="grid-4" id="maintEffectStats"></div>
            <div class="card">
                <h3>ç¶­è­·å‰å¾Œæ¯”è¼ƒ</h3>
                <table class="data-table" id="maintEffectTable">
                    <thead><tr><th>æ©Ÿå°</th><th>é¡å‹</th><th>ç¶­è­·å‰</th><th>ç¶­è­·å¾Œ</th><th>æ”¹å–„</th><th>æœ‰æ•ˆ</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="insight-box">
                <span class="icon">ğŸ› ï¸</span>
                <span class="text" id="maintEffectInsight">è¼‰å…¥ä¸­...</span>
            </div>
            <div class="recommendation-box">
                <div class="rec-header">ğŸ’¼ ä¼æ¥­ä¸»å»ºè­°</div>
                <div class="rec-content">
                    <div class="rec-item">
                        <span class="rec-tag">ç¶­è­·é¡å‹</span>
                        PM = é é˜²æ€§ç¶­è­·ï¼ˆå®šæœŸï¼‰<br>
                        BD = æ•…éšœç¶­ä¿®ï¼ˆè‡¨æ™‚ï¼‰
                    </div>
                    <div class="rec-item">
                        <span class="rec-tag">ç­–ç•¥å»ºè­°</span>
                        1. æé«˜ PM é »ç‡ï¼Œæ¸›å°‘ BD ç™¼ç”Ÿ<br>
                        2. ç„¡æ•ˆç¶­è­·éœ€æª¢è¨ SOP<br>
                        3. å»ºç«‹ç¶­è­·æ•ˆæœè¿½è¹¤æ©Ÿåˆ¶
                    </div>
                    <div class="rec-item success">
                        <span class="rec-tag">æ ¸å¿ƒæŒ‡æ¨™</span>
                        ç¶­è­·æœ‰æ•ˆç‡æ‡‰ ><strong>80%</strong>ï¼Œå¦å‰‡éœ€æª¢è¨ç¶­è­·å“è³ª
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SPC æ§åˆ¶åœ– Tab -->
        <div id="tab-spc" class="tab-content">
            <div class="grid-4" id="spcStats"></div>
            <div class="grid-2">
                <div class="card">
                    <h3>X-bar æ§åˆ¶åœ–ï¼ˆæ—¥å¹³å‡ä¸è‰¯ç‡ï¼‰</h3>
                    <div class="chart-container"><canvas id="xbarChart"></canvas></div>
                </div>
                <div class="card">
                    <h3>ç§»å‹•ç¯„åœåœ–ï¼ˆMR Chartï¼‰</h3>
                    <div class="chart-container"><canvas id="mrChart"></canvas></div>
                </div>
            </div>
            <div class="card">
                <h3>âš ï¸ æ§åˆ¶ç·šé•è¦è¨˜éŒ„</h3>
                <div id="spcViolations"></div>
            </div>
            <div class="insight-box">
                <span class="icon">ğŸ“‰</span>
                <span class="text" id="spcInsight">è¼‰å…¥ä¸­...</span>
            </div>
            <div class="recommendation-box">
                <div class="rec-header">ğŸ’¼ ä¼æ¥­ä¸»å»ºè­°</div>
                <div class="rec-content">
                    <div class="rec-item">
                        <span class="rec-tag">SPC åŸºç¤</span>
                        UCL = ä¸Šæ§åˆ¶ç·šï¼ˆå¹³å‡ + 3Ïƒï¼‰<br>
                        LCL = ä¸‹æ§åˆ¶ç·šï¼ˆå¹³å‡ - 3Ïƒï¼‰<br>
                        è¶…å‡º = è£½ç¨‹ç•°å¸¸
                    </div>
                    <div class="rec-item critical">
                        <span class="rec-tag">ç•°å¸¸è™•ç†</span>
                        1. è¶…å‡ºæ§åˆ¶ç·š â†’ ç«‹å³èª¿æŸ¥æ ¹å› <br>
                        2. é€£çºŒ 7 é»åŒå´ â†’ è£½ç¨‹åç§»è­¦ç¤º<br>
                        3. é€£çºŒä¸Šå‡/ä¸‹é™ â†’ è¶¨å‹¢è­¦ç¤º
                    </div>
                    <div class="rec-item success">
                        <span class="rec-tag">å“è³ªå‡ç´š</span>
                        å°å…¥ SPC å¯å°‡ä¸è‰¯ç‡å†é™ <strong>20-30%</strong>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç¸½çµè¡Œå‹•æ¸…å–®ï¼ˆæ‰€æœ‰ Tab å¯è¦‹ï¼‰-->
        <div class="action-summary">
            <div class="summary-header">ğŸ“‹ ç¸½çµï¼šä¼æ¥­ä¸»è¡Œå‹•æ¸…å–®</div>
            <div class="action-grid">
                <div class="action-item priority-1">
                    <div class="priority-badge">ğŸ”´ å„ªå…ˆ1</div>
                    <div class="action-title">300h ç¶­è­·åˆ¶åº¦</div>
                    <div class="action-desc">è¶…æ™‚å³åœï¼Œæœ¬é€±åŸ·è¡Œ</div>
                    <div class="action-benefit">å¹´çœ Â¥500è¬</div>
                </div>
                <div class="action-item priority-1">
                    <div class="priority-badge">ğŸ”´ å„ªå…ˆ2</div>
                    <div class="action-title">å†·å»ç³»çµ±æª¢æŸ¥</div>
                    <div class="action-desc">ç›®æ¨™æº«åº¦ <66Â°Cï¼Œ2é€±å…§</div>
                    <div class="action-benefit">å¹´çœ Â¥1,000è¬</div>
                </div>
                <div class="action-item priority-2">
                    <div class="priority-badge">ğŸŸ  å„ªå…ˆ3</div>
                    <div class="action-title">L09 ç”¢ç·šå°ˆæ¡ˆ</div>
                    <div class="action-desc">èª¿æŸ¥æå¤±æ ¹å› ï¼Œ1å€‹æœˆ</div>
                    <div class="action-benefit">å¹´çœ Â¥200è¬</div>
                </div>
                <div class="action-item priority-2">
                    <div class="priority-badge">ğŸŸ  å„ªå…ˆ4</div>
                    <div class="action-title">S05 ä¾›æ‡‰å•†æ·˜æ±°</div>
                    <div class="action-desc">æ¸›å°‘æ¡è³¼æ¯”ä¾‹ï¼Œæœ¬å­£</div>
                    <div class="action-benefit">å¹´çœ Â¥100è¬</div>
                </div>
                <div class="action-item priority-3">
                    <div class="priority-badge">ğŸŸ¢ å„ªå…ˆ5</div>
                    <div class="action-title">S04 å¢åŠ åˆä½œ</div>
                    <div class="action-desc">æœ€ä½³ä¾›æ‡‰å•†ï¼Œæœ¬å­£</div>
                    <div class="action-benefit">å“è³ªæå‡</div>
                </div>
            </div>
            <div class="summary-footer">
                ğŸ’¡ <strong>ä¸€å¥è©±ç¸½çµ</strong>ï¼šå¹´æ Â¥1,915è¬ ä¸­ï¼Œè‡³å°‘ Â¥1,000è¬ å¯ä»¥é€éã€Œ300h ç¶­è­· + æº«åº¦æ§åˆ¶ã€æŒ½å›ã€‚<strong>é€™ä¸æ˜¯èŠ±éŒ¢ï¼Œæ˜¯æ’¿éŒ¢ã€‚</strong>
            </div>
        </div>
    </div>
    
    <script>
        // Tab åˆ‡æ›
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            event.target.classList.add('active');
        }
        
        // é€šç”¨åœ–è¡¨é…ç½®
        const chartConfig = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#888' } } },
            scales: {
                y: { ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                x: { ticks: { color: '#888' }, grid: { display: false } }
            }
        };
        
        // è¼‰å…¥ç¸½è¦½
        async function loadOverview() {
            const stats = await fetch('/api/zw_stats').then(r => r.json());
            document.getElementById('overviewStats').innerHTML = `
                <div class="stat-card"><div class="value">${stats.batch_count}</div><div class="label">æ‰¹æ¬¡æ•¸</div></div>
                <div class="stat-card"><div class="value">${stats.line_count}</div><div class="label">ç”¢ç·š</div></div>
                <div class="stat-card"><div class="value">${stats.yield_rate}%</div><div class="label">å¹³å‡è‰¯ç‡</div></div>
                <div class="stat-card"><div class="value">${stats.day_count}</div><div class="label">æ•¸æ“šå¤©æ•¸</div></div>
            `;
            
            const trend = await fetch('/api/zw_yield_trend').then(r => r.json());
            new Chart(document.getElementById('yieldTrendChart'), {
                type: 'line',
                data: { labels: trend.labels, datasets: [{ label: 'è‰¯ç‡%', data: trend.yield_data, borderColor: '#4472C4', backgroundColor: 'rgba(68,114,196,0.1)', fill: true, tension: 0.3 }] },
                options: { ...chartConfig, scales: { ...chartConfig.scales, y: { ...chartConfig.scales.y, min: 80, max: 100 } } }
            });
            
            const perf = await fetch('/api/zw_line_performance').then(r => r.json());
            new Chart(document.getElementById('linePerformanceChart'), {
                type: 'bar',
                data: { labels: perf.labels, datasets: [{ label: 'è‰¯ç‡%', data: perf.yield_data, backgroundColor: perf.yield_data.map(v => v >= 90 ? '#28a745' : v >= 85 ? '#ffc107' : '#dc3545'), borderRadius: 4 }] },
                options: { ...chartConfig, plugins: { legend: { display: false } }, scales: { ...chartConfig.scales, y: { ...chartConfig.scales.y, min: 80 } } }
            });
            
            const heatmap = await fetch('/api/zw_defect_heatmap').then(r => r.json());
            let html = '<div style="display:grid;grid-template-columns:auto repeat(' + heatmap.shifts.length + ',1fr);gap:3px;font-size:0.8em">';
            html += '<div></div>' + heatmap.shifts.map(s => `<div style="text-align:center;color:#888">ç­${s}</div>`).join('');
            heatmap.lines.forEach(line => {
                html += `<div style="color:#888">${line}</div>`;
                heatmap.shifts.forEach(shift => {
                    const item = heatmap.data.find(d => d.line === line && d.shift === shift);
                    const rate = item ? item.defect_rate : 0;
                    const color = rate < 10 ? '#28a745' : rate < 15 ? '#ffc107' : '#dc3545';
                    html += `<div style="background:${color}20;color:${color};padding:8px;text-align:center;border-radius:4px">${rate}%</div>`;
                });
            });
            document.getElementById('heatmapContainer').innerHTML = html + '</div>';
            
            const ops = await fetch('/api/zw_operator_ranking').then(r => r.json());
            document.querySelector('#operatorTable tbody').innerHTML = ops.top.map((o, i) => `
                <tr><td>${i+1}</td><td>${o.operator_id}</td><td>${o.batch_count}</td><td style="color:${o.yield_rate>=90?'#28a745':'#ffc107'}">${o.yield_rate}%</td></tr>
            `).join('');
        }
        
        // è¼‰å…¥ç¶­è­·è­¦ç¤º
        async function loadMaintenance() {
            const data = await fetch('/api/zw_maintenance_alert').then(r => r.json());
            document.getElementById('maintenanceStats').innerHTML = `
                <div class="stat-card alert"><div class="value">${data.maintenance_alerts.length}</div><div class="label">éœ€ç¶­è­·æ©Ÿå°</div></div>
                <div class="stat-card warning"><div class="value">${data.threshold}h</div><div class="label">ç¶­è­·è‡¨ç•Œé»</div></div>
                <div class="stat-card"><div class="value">${data.runtime_analysis[3]?.defect_rate || '-'}%</div><div class="label">>300h ä¸è‰¯ç‡</div></div>
                <div class="stat-card success"><div class="value">${data.runtime_analysis[0]?.defect_rate || '-'}%</div><div class="label"><100h ä¸è‰¯ç‡</div></div>
            `;
            new Chart(document.getElementById('runtimeChart'), {
                type: 'bar',
                data: { labels: data.runtime_analysis.map(r => r.range), datasets: [{ label: 'ä¸è‰¯ç‡%', data: data.runtime_analysis.map(r => r.defect_rate), backgroundColor: data.runtime_analysis.map(r => r.defect_rate > 10 ? '#dc3545' : r.defect_rate > 5 ? '#ffc107' : '#28a745'), borderRadius: 4 }] },
                options: { ...chartConfig, plugins: { legend: { display: false } } }
            });
            document.getElementById('maintenanceAlerts').innerHTML = data.maintenance_alerts.slice(0, 6).map(a => `
                <div class="alert-card ${a.urgency === 'HIGH' ? '' : 'warning'}">
                    <span class="machine">${a.machine_id}</span>
                    <span class="badge badge-${a.urgency.toLowerCase()}">${a.urgency}</span>
                    <div class="detail">é‹è¡Œ ${a.runtime_hours}h | è¿‘æœŸä¸è‰¯ ${a.recent_defect}%</div>
                </div>
            `).join('') || '<div style="color:#888;text-align:center;padding:20px">ç„¡éœ€ç¶­è­·çš„æ©Ÿå°</div>';
            document.getElementById('maintenanceInsight').textContent = data.insight;
        }
        
        // è¼‰å…¥æº«åº¦åˆ†æ
        async function loadTemperature() {
            const data = await fetch('/api/zw_temp_analysis').then(r => r.json());
            new Chart(document.getElementById('tempRangeChart'), {
                type: 'bar',
                data: { labels: data.temp_ranges.map(t => t.temp_range), datasets: [{ label: 'ä¸è‰¯ç‡%', data: data.temp_ranges.map(t => t.avg_defect_pct), backgroundColor: data.temp_ranges.map(t => t.avg_defect_pct > 10 ? '#dc3545' : t.avg_defect_pct > 5 ? '#ffc107' : '#28a745'), borderRadius: 4 }] },
                options: { ...chartConfig, plugins: { legend: { display: false } } }
            });
            new Chart(document.getElementById('lineTempChart'), {
                type: 'scatter',
                data: { datasets: [{ label: 'ç”¢ç·š', data: data.line_temperature.map(l => ({ x: l.avg_temp, y: l.avg_defect })), backgroundColor: '#4472C4', pointRadius: 8 }] },
                options: { ...chartConfig, scales: { x: { ...chartConfig.scales.x, title: { display: true, text: 'æº«åº¦Â°C', color: '#888' } }, y: { ...chartConfig.scales.y, title: { display: true, text: 'ä¸è‰¯ç‡%', color: '#888' } } } }
            });
            document.getElementById('tempInsight').textContent = data.insight;
        }
        
        // è¼‰å…¥æˆæœ¬åˆ†æ
        async function loadCost() {
            const data = await fetch('/api/zw_cost_analysis').then(r => r.json());
            document.getElementById('costStats').innerHTML = `
                <div class="stat-card alert"><div class="value">Â¥${(data.total_loss_60d/10000).toFixed(1)}è¬</div><div class="label">60å¤©æå¤±</div></div>
                <div class="stat-card warning"><div class="value">Â¥${(data.total_loss_annual/10000).toFixed(1)}è¬</div><div class="label">å¹´åŒ–æå¤±</div></div>
                <div class="stat-card"><div class="value">${data.line_loss.length}</div><div class="label">ç”¢ç·šæ•¸</div></div>
            `;
            new Chart(document.getElementById('lineLossChart'), {
                type: 'bar',
                data: { labels: data.line_loss.map(l => l.line_id), datasets: [{ label: 'æå¤±(å…ƒ)', data: data.line_loss.map(l => l.loss_60d), backgroundColor: '#dc3545', borderRadius: 4 }] },
                options: { ...chartConfig, plugins: { legend: { display: false } } }
            });
            new Chart(document.getElementById('supplierLossChart'), {
                type: 'bar',
                data: { labels: data.supplier_loss.map(s => s.supplier_id), datasets: [{ label: 'æå¤±(å…ƒ)', data: data.supplier_loss.map(s => s.loss_60d), backgroundColor: '#fd7e14', borderRadius: 4 }] },
                options: { ...chartConfig, indexAxis: 'y', plugins: { legend: { display: false } } }
            });
            document.getElementById('costInsight').textContent = data.insight;
        }
        
        // è¼‰å…¥ä¾›æ‡‰å•†è©•åˆ†
        async function loadSupplier() {
            const data = await fetch('/api/zw_supplier_scorecard').then(r => r.json());
            document.getElementById('supplierScorecards').innerHTML = data.scorecards.map(s => `
                <div class="score-card">
                    <div class="info">
                        <div class="name">${s.supplier_id} - ${s.supplier_name}</div>
                        <div class="metrics">è‰¯ç‡ ${s.yield_rate}% | æˆæœ¬ä¿‚æ•¸ ${s.cost_multiplier} | é€±æœŸ ${s.avg_cycle}s</div>
                        <div style="margin-top:8px;display:flex;gap:15px;font-size:0.8em">
                            <span>å“è³ª <strong>${s.quality_score}</strong></span>
                            <span>æˆæœ¬ <strong>${s.cost_score}</strong></span>
                            <span>äº¤æœŸ <strong>${s.delivery_score}</strong></span>
                            <span>ç¸½åˆ† <strong style="color:#4472C4">${s.total_score}</strong></span>
                        </div>
                    </div>
                    <div class="grade grade-${s.grade}">${s.grade}</div>
                </div>
            `).join('');
            document.getElementById('supplierInsight').textContent = data.insight;
        }
        
        // è¼‰å…¥é æ¸¬ç¶­è­·
        async function loadPredictive() {
            const data = await fetch('/api/zw_predictive_score').then(r => r.json());
            document.getElementById('predictiveStats').innerHTML = `
                <div class="stat-card alert"><div class="value">${data.critical_count}</div><div class="label">CRITICAL</div></div>
                <div class="stat-card warning"><div class="value">${data.high_count}</div><div class="label">HIGH</div></div>
                <div class="stat-card"><div class="value">${data.machine_health.length}</div><div class="label">ç›£æ§æ©Ÿå°</div></div>
                <div class="stat-card success"><div class="value">${data.weights.runtime}/${data.weights.temperature}/${data.weights.vibration}</div><div class="label">æ¬Šé‡é…æ¯”</div></div>
            `;
            document.querySelector('#healthTable tbody').innerHTML = data.machine_health.map(m => `
                <tr>
                    <td><strong>${m.machine_id}</strong></td>
                    <td>${m.runtime_hours}h</td>
                    <td>${m.avg_temp}Â°C</td>
                    <td>${m.avg_vibration}</td>
                    <td><strong style="color:${m.health_score<50?'#dc3545':m.health_score<70?'#ffc107':'#28a745'}">${m.health_score}</strong></td>
                    <td><span class="badge badge-${m.risk_level.toLowerCase()}">${m.risk_level}</span></td>
                    <td style="color:#888">${m.recommendation}</td>
                </tr>
            `).join('');
            document.getElementById('predictiveInsight').textContent = data.insight;
        }
        
        // è¼‰å…¥æŒ¯å‹•åˆ†æ
        async function loadVibration() {
            const data = await fetch('/api/zw_vibration_analysis').then(r => r.json());
            
            document.getElementById('vibrationStats').innerHTML = `
                <div class="stat-card alert"><div class="value">${data.critical_count}</div><div class="label">é«˜å±æ©Ÿå°</div></div>
                <div class="stat-card warning"><div class="value">${data.warning_count}</div><div class="label">è­¦å‘Šæ©Ÿå°</div></div>
                <div class="stat-card"><div class="value">${data.threshold}</div><div class="label">è­¦æˆ’ç·š</div></div>
                <div class="stat-card success"><div class="value">${data.vib_ranges[0]?.avg_defect_pct || '-'}%</div><div class="label">ä½æŒ¯å‹•ä¸è‰¯ç‡</div></div>
            `;
            
            new Chart(document.getElementById('vibRangeChart'), {
                type: 'bar',
                data: { labels: data.vib_ranges.map(v => v.vib_range), datasets: [{ label: 'ä¸è‰¯ç‡%', data: data.vib_ranges.map(v => v.avg_defect_pct), backgroundColor: data.vib_ranges.map(v => v.avg_defect_pct > 10 ? '#dc3545' : v.avg_defect_pct > 5 ? '#ffc107' : '#28a745'), borderRadius: 4 }] },
                options: { ...chartConfig, plugins: { legend: { display: false } } }
            });
            
            new Chart(document.getElementById('vibTrendChart'), {
                type: 'line',
                data: { labels: data.vib_trend.map(v => v.date), datasets: [
                    { label: 'æŒ¯å‹•', data: data.vib_trend.map(v => v.avg_vib), borderColor: '#fd7e14', yAxisID: 'y' },
                    { label: 'ä¸è‰¯ç‡%', data: data.vib_trend.map(v => v.defect_pct), borderColor: '#dc3545', yAxisID: 'y1' }
                ] },
                options: { ...chartConfig, scales: { y: { ...chartConfig.scales.y, position: 'left' }, y1: { ...chartConfig.scales.y, position: 'right', grid: { drawOnChartArea: false } } } }
            });
            
            document.querySelector('#vibMachineTable tbody').innerHTML = data.machine_vibration.map(m => `
                <tr>
                    <td><strong>${m.machine_id}</strong></td>
                    <td>${m.avg_vib}</td>
                    <td>${m.max_vib}</td>
                    <td>${m.defect_pct}%</td>
                    <td><span class="badge badge-${m.avg_vib > 3 ? 'critical' : m.avg_vib > 2.5 ? 'high' : 'low'}">${m.avg_vib > 3 ? 'å±éšª' : m.avg_vib > 2.5 ? 'è­¦å‘Š' : 'æ­£å¸¸'}</span></td>
                </tr>
            `).join('');
            
            document.getElementById('vibrationInsight').textContent = data.insight;
        }
        
        // è¼‰å…¥å¤šå› å­åˆ†æ
        async function loadMultifactor() {
            const data = await fetch('/api/zw_multifactor').then(r => r.json());
            
            // ä¸‰å› å­çŸ©é™£
            let matrixHtml = '<div style="font-size:0.85em">';
            data.factor_matrix.forEach((f, i) => {
                const color = f.defect_pct > 15 ? '#dc3545' : f.defect_pct > 10 ? '#fd7e14' : f.defect_pct > 5 ? '#ffc107' : '#28a745';
                matrixHtml += `<div style="display:flex;justify-content:space-between;padding:8px;margin:4px 0;background:${color}20;border-radius:6px;border-left:3px solid ${color}">
                    <span>${f.temp_g} + ${f.rt_g} + ${f.vib_g}</span>
                    <span><strong style="color:${color}">${f.defect_pct}%</strong> (${f.batch_count.toLocaleString()}æ‰¹)</span>
                </div>`;
            });
            matrixHtml += '</div>';
            document.getElementById('factorMatrix').innerHTML = matrixHtml;
            
            // ç†±åŠ›åœ–
            const temps = [...new Set(data.heatmap_data.map(h => h.temp_range))];
            const runtimes = [...new Set(data.heatmap_data.map(h => h.runtime_range))];
            let heatmapHtml = '<div style="display:grid;grid-template-columns:auto repeat(' + runtimes.length + ',1fr);gap:3px;font-size:0.8em">';
            heatmapHtml += '<div></div>' + runtimes.map(r => `<div style="text-align:center;color:#888">${r}</div>`).join('');
            temps.forEach(temp => {
                heatmapHtml += `<div style="color:#888">${temp}</div>`;
                runtimes.forEach(rt => {
                    const item = data.heatmap_data.find(h => h.temp_range === temp && h.runtime_range === rt);
                    const rate = item ? item.defect_pct : 0;
                    const color = rate > 15 ? '#dc3545' : rate > 10 ? '#fd7e14' : rate > 5 ? '#ffc107' : '#28a745';
                    heatmapHtml += `<div style="background:${color}30;color:${color};padding:10px;text-align:center;border-radius:4px">${rate}%</div>`;
                });
            });
            heatmapHtml += '</div>';
            document.getElementById('factorHeatmap').innerHTML = heatmapHtml;
            
            document.getElementById('multifactorInsight').textContent = data.insight;
        }
        
        // è¼‰å…¥æ™‚æ®µåˆ†æ
        async function loadTimePattern() {
            const data = await fetch('/api/zw_time_pattern').then(r => r.json());
            
            new Chart(document.getElementById('hourlyChart'), {
                type: 'bar',
                data: { labels: data.hourly.map(h => h.hour + ':00'), datasets: [{ label: 'ä¸è‰¯ç‡%', data: data.hourly.map(h => h.defect_pct), backgroundColor: data.hourly.map(h => h.defect_pct > 14.3 ? '#dc3545' : h.defect_pct > 14 ? '#ffc107' : '#28a745'), borderRadius: 2 }] },
                options: { ...chartConfig, plugins: { legend: { display: false } } }
            });
            
            new Chart(document.getElementById('weeklyChart'), {
                type: 'bar',
                data: { labels: data.weekly.map(w => w.weekday), datasets: [{ label: 'ä¸è‰¯ç‡%', data: data.weekly.map(w => w.defect_pct), backgroundColor: data.weekly.map(w => w.defect_pct > 14.3 ? '#dc3545' : w.defect_pct > 14 ? '#ffc107' : '#28a745'), borderRadius: 4 }] },
                options: { ...chartConfig, plugins: { legend: { display: false } } }
            });
            
            // ç­æ¬¡Ã—æ™‚æ®µç†±åŠ›åœ–
            const shifts = [...new Set(data.shift_hour.map(s => s.shift))].sort();
            const hours = [...new Set(data.shift_hour.map(s => s.hour))].sort();
            let shHtml = '<div style="display:grid;grid-template-columns:auto repeat(' + hours.length + ',1fr);gap:2px;font-size:0.75em;overflow-x:auto">';
            shHtml += '<div></div>' + hours.map(h => `<div style="text-align:center;color:#888">${h}</div>`).join('');
            shifts.forEach(shift => {
                shHtml += `<div style="color:#888">ç­${shift}</div>`;
                hours.forEach(hour => {
                    const item = data.shift_hour.find(s => s.shift == shift && s.hour == hour);
                    const rate = item ? item.defect_pct : 0;
                    const color = rate > 14.5 ? '#dc3545' : rate > 14 ? '#ffc107' : '#28a745';
                    shHtml += `<div style="background:${color}30;color:${color};padding:4px;text-align:center;border-radius:2px">${rate}</div>`;
                });
            });
            shHtml += '</div>';
            document.getElementById('shiftHourHeatmap').innerHTML = shHtml;
            
            document.getElementById('timepatternInsight').textContent = data.insight;
        }
        
        // è¼‰å…¥ç¶­è­·æ•ˆæœ
        async function loadMaintEffect() {
            const data = await fetch('/api/zw_maintenance_effect').then(r => r.json());
            
            document.getElementById('maintEffectStats').innerHTML = `
                <div class="stat-card ${data.effective_rate > 70 ? 'success' : 'warning'}"><div class="value">${data.effective_rate}%</div><div class="label">ç¶­è­·æœ‰æ•ˆç‡</div></div>
                <div class="stat-card"><div class="value">${data.avg_improvement}%</div><div class="label">å¹³å‡æ”¹å–„</div></div>
                <div class="stat-card"><div class="value">${data.pm_effectiveness}%</div><div class="label">PM æœ‰æ•ˆç‡</div></div>
                <div class="stat-card"><div class="value">${data.bd_effectiveness}%</div><div class="label">BD æœ‰æ•ˆç‡</div></div>
            `;
            
            document.querySelector('#maintEffectTable tbody').innerHTML = data.before_after.map(m => `
                <tr>
                    <td><strong>${m.machine_id}</strong></td>
                    <td><span class="badge badge-${m.maint_type === 'PM' ? 'low' : 'medium'}">${m.maint_type}</span></td>
                    <td>${m.before_defect}%</td>
                    <td>${m.after_defect}%</td>
                    <td style="color:${m.improvement > 0 ? '#28a745' : '#dc3545'}">${m.improvement > 0 ? 'â†“' : 'â†‘'}${Math.abs(m.improvement)}%</td>
                    <td><span class="badge badge-${m.effective ? 'low' : 'critical'}">${m.effective ? 'âœ“' : 'âœ—'}</span></td>
                </tr>
            `).join('');
            
            document.getElementById('maintEffectInsight').textContent = data.insight;
        }
        
        // è¼‰å…¥ SPC æ§åˆ¶åœ–
        async function loadSPC() {
            const data = await fetch('/api/zw_spc_chart').then(r => r.json());
            
            document.getElementById('spcStats').innerHTML = `
                <div class="stat-card"><div class="value">${data.mean}%</div><div class="label">å¹³å‡ (CL)</div></div>
                <div class="stat-card alert"><div class="value">${data.ucl}%</div><div class="label">ä¸Šæ§åˆ¶ç·š (UCL)</div></div>
                <div class="stat-card success"><div class="value">${data.lcl}%</div><div class="label">ä¸‹æ§åˆ¶ç·š (LCL)</div></div>
                <div class="stat-card ${data.out_of_control_count > 3 ? 'alert' : 'success'}"><div class="value">${data.out_of_control_count}</div><div class="label">è¶…ç·šé»æ•¸</div></div>
            `;
            
            new Chart(document.getElementById('xbarChart'), {
                type: 'line',
                data: {
                    labels: data.xbar_data.map(d => d.date),
                    datasets: [
                        { label: 'ä¸è‰¯ç‡', data: data.xbar_data.map(d => d.avg_defect), borderColor: '#4472C4', pointBackgroundColor: data.xbar_data.map(d => d.out_of_control ? '#dc3545' : '#4472C4'), pointRadius: data.xbar_data.map(d => d.out_of_control ? 6 : 3) },
                        { label: 'UCL', data: data.xbar_data.map(() => data.ucl), borderColor: '#dc3545', borderDash: [5,5], pointRadius: 0 },
                        { label: 'CL', data: data.xbar_data.map(() => data.mean), borderColor: '#28a745', borderDash: [2,2], pointRadius: 0 },
                        { label: 'LCL', data: data.xbar_data.map(() => data.lcl), borderColor: '#dc3545', borderDash: [5,5], pointRadius: 0 }
                    ]
                },
                options: { ...chartConfig, plugins: { legend: { labels: { color: '#888' } } } }
            });
            
            new Chart(document.getElementById('mrChart'), {
                type: 'line',
                data: { labels: data.mr_data.map(d => d.date), datasets: [{ label: 'ç§»å‹•ç¯„åœ', data: data.mr_data.map(d => d.mr), borderColor: '#fd7e14', fill: true, backgroundColor: 'rgba(253,126,20,0.1)' }] },
                options: { ...chartConfig, plugins: { legend: { display: false } } }
            });
            
            // é•è¦è¨˜éŒ„
            let violHtml = data.violations.length > 0 
                ? data.violations.map(v => `<div class="alert-card warning"><strong>${v.date}</strong>ï¼š${v.type}</div>`).join('')
                : '<div style="color:#888;text-align:center;padding:20px">ç„¡æ§åˆ¶ç·šé•è¦</div>';
            document.getElementById('spcViolations').innerHTML = violHtml;
            
            document.getElementById('spcInsight').textContent = data.insight;
        }
        
        // æ™‚é–“ç¯©é¸
        let currentDateRange = 30;
        let currentLineFilter = 'all';
        
        function applyDateFilter() {
            currentDateRange = parseInt(document.getElementById('dateRange').value);
            refreshAllData();
        }
        
        function applyLineFilter() {
            currentLineFilter = document.getElementById('lineFilter').value;
            refreshAllData();
        }
        
        function refreshAllData() {
            // æ¸…é™¤èˆŠåœ–è¡¨
            Chart.helpers.each(Chart.instances, (instance) => {
                instance.destroy();
            });
            // é‡æ–°è¼‰å…¥
            loadOverview();
            loadMaintenance();
            loadTemperature();
            loadCost();
            loadSupplier();
            loadPredictive();
            loadVibration();
            loadMultifactor();
            loadTimePattern();
            loadMaintEffect();
            loadSPC();
        }
        
        // è¼‰å…¥ç”¢ç·šé¸é …
        async function loadLineOptions() {
            const perf = await fetch('/api/zw_line_performance').then(r => r.json());
            const select = document.getElementById('lineFilter');
            perf.labels.forEach(line => {
                const option = document.createElement('option');
                option.value = line;
                option.textContent = line;
                select.appendChild(option);
            });
        }
        
        // åŒ¯å‡º PDF
        function exportPDF() {
            alert('ğŸ“„ PDF åŒ¯å‡ºåŠŸèƒ½\\n\\næ­£åœ¨æº–å‚™å ±å‘Š...\\n\\næç¤ºï¼šæ­¤åŠŸèƒ½éœ€è¦å¾Œç«¯æ”¯æ´ã€‚\\nç›®å‰å¯ä½¿ç”¨ç€è¦½å™¨åˆ—å°åŠŸèƒ½ (Ctrl+P) å¦å­˜ç‚º PDFã€‚');
            window.print();
        }
        
        // åŒ¯å‡º Excel
        function exportExcel() {
            // æ”¶é›†æ•¸æ“š
            const data = {
                title: 'æ·±åº¦åˆ†æå ±å‘Š',
                date: new Date().toISOString().slice(0, 10),
                sections: []
            };
            
            // ç”Ÿæˆ CSV
            let csv = 'æ·±åº¦åˆ†æå ±å‘Š\\n';
            csv += 'åŒ¯å‡ºæ™‚é–“,' + new Date().toLocaleString() + '\\n\\n';
            
            // ç¸½è¦½çµ±è¨ˆ
            csv += '=== ç¸½è¦½çµ±è¨ˆ ===\\n';
            const stats = document.getElementById('overviewStats');
            if (stats) {
                const values = stats.querySelectorAll('.value');
                const labels = stats.querySelectorAll('.label');
                labels.forEach((label, i) => {
                    csv += label.textContent + ',' + values[i].textContent + '\\n';
                });
            }
            csv += '\\n';
            
            // æ“ä½œå“¡æ’å
            csv += '=== æ“ä½œå“¡ Top 10 ===\\n';
            csv += 'æ’å,æ“ä½œå“¡,æ‰¹æ¬¡,è‰¯ç‡\\n';
            const rows = document.querySelectorAll('#operatorTable tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                csv += Array.from(cells).map(c => c.textContent).join(',') + '\\n';
            });
            csv += '\\n';
            
            // ä¸‹è¼‰
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'analysis_report_' + new Date().toISOString().slice(0, 10) + '.csv';
            link.click();
            
            alert('ğŸ“Š Excel åŒ¯å‡ºå®Œæˆï¼\\n\\nå·²ä¸‹è¼‰ CSV æª”æ¡ˆï¼Œå¯ç”¨ Excel é–‹å•Ÿã€‚');
        }
        
        // åˆå§‹åŒ–
        loadLineOptions();
        loadOverview();
        loadMaintenance();
        loadTemperature();
        loadCost();
        loadSupplier();
        loadPredictive();
        loadVibration();
        loadMultifactor();
        loadTimePattern();
        loadMaintEffect();
        loadSPC();
    </script>
</body>
</html>
