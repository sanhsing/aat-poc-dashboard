<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM æŸ¥è©¢ç³»çµ± v3.2 | æ­£å´´ PoC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .typing-indicator::after { content: '|'; animation: blink 1s infinite; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
        .fade-in { animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .chat-bubble { max-width: 85%; }
        pre { white-space: pre-wrap; word-wrap: break-word; background: #1e293b; color: #e2e8f0; padding: 12px; border-radius: 8px; font-size: 12px; }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="min-h-screen bg-gray-100">
    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="bg-gradient-to-r from-orange-600 to-orange-500 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold flex items-center gap-2">
                        <span class="text-2xl">ğŸ¦Š</span> FoxLink LLM æŸ¥è©¢å¹³å°
                    </h1>
                    <p class="text-xs text-orange-100">æ­£å´´ PoC Â· DB é©…å‹•æŸ¥è©¢ Â· PYLIB v3.18</p>
                </div>
                <div class="flex gap-2">
                    <a href="/" class="px-3 py-1 bg-white text-orange-600 rounded text-xs hover:bg-orange-50">ğŸ“Š Dashboard</a>
                    <span class="px-3 py-1 bg-green-500 rounded-full text-xs font-bold">Live</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="stat-card bg-white rounded-xl shadow p-4 border-l-4 border-blue-500">
                <p class="text-gray-500 text-xs">è³‡æ–™è¡¨æ•¸</p>
                <p class="text-2xl font-bold text-blue-600" id="stat-tables">-</p>
            </div>
            <div class="stat-card bg-white rounded-xl shadow p-4 border-l-4 border-green-500">
                <p class="text-gray-500 text-xs">ç¸½è³‡æ–™é‡</p>
                <p class="text-2xl font-bold text-green-600" id="stat-rows">-</p>
            </div>
            <div class="stat-card bg-white rounded-xl shadow p-4 border-l-4 border-purple-500">
                <p class="text-gray-500 text-xs">ç”Ÿç”¢ç·šæ•¸</p>
                <p class="text-2xl font-bold text-purple-600" id="stat-lines">-</p>
            </div>
            <div class="stat-card bg-white rounded-xl shadow p-4 border-l-4 border-orange-500">
                <p class="text-gray-500 text-xs">å¹³å‡è‰¯ç‡</p>
                <p class="text-2xl font-bold text-orange-600"><span id="stat-yield">-</span>%</p>
            </div>
        </div>

        <div class="grid lg:grid-cols-4 gap-6">
            <!-- å·¦å´ï¼šå¿«é€Ÿå•é¡Œ -->
            <div class="lg:col-span-1 space-y-4">
                <div class="bg-white rounded-xl shadow-lg p-4">
                    <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <span class="text-xl">ğŸ’¡</span> PoC å•é¡Œæ¸…å–®
                    </h3>
                    <div class="space-y-1.5 text-xs">
                        <p class="text-gray-500 font-medium">ä¸€ã€è³‡æ–™è¼ªå»“</p>
                        <button onclick="askQuestion('ç›®å‰å…±æœ‰å¤šå°‘è¡¨ï¼Ÿè³‡æ–™æ•¸æœ‰å¤šå°‘ï¼Ÿ')" class="w-full text-left p-2 bg-blue-50 hover:bg-blue-100 rounded border-l-4 border-blue-400">
                            #1 å…±æœ‰å¤šå°‘è¡¨ï¼Ÿ
                        </button>
                        <button onclick="askQuestion('å» æˆ¿æœ‰å¤šå°‘ç”Ÿç”¢ç·šï¼Ÿ')" class="w-full text-left p-2 bg-blue-50 hover:bg-blue-100 rounded border-l-4 border-blue-400">
                            #2 æœ‰å¤šå°‘ç”Ÿç”¢ç·šï¼Ÿ
                        </button>
                        
                        <p class="text-gray-500 font-medium mt-3">äºŒã€ç”Ÿç”¢åˆ†æ</p>
                        <button onclick="askQuestion('908ç·šçš„ç”¢èƒ½å¦‚ä½•ï¼Ÿ')" class="w-full text-left p-2 bg-green-50 hover:bg-green-100 rounded border-l-4 border-green-400">
                            #3 908ç·šç”¢èƒ½ï¼Ÿ
                        </button>
                        <button onclick="askQuestion('å„ç”¢ç·šçš„ä¸è‰¯ç‡ç‚ºå¤šå°‘ï¼Ÿ')" class="w-full text-left p-2 bg-green-50 hover:bg-green-100 rounded border-l-4 border-green-400">
                            #4 å„ç·šä¸è‰¯ç‡ï¼Ÿ
                        </button>
                        <button onclick="askQuestion('å“ªæ¢ç·šè‰¯ç‡æœ€ä½ï¼Ÿå“ªå¤©ç™¼ç”Ÿï¼Ÿ')" class="w-full text-left p-2 bg-green-50 hover:bg-green-100 rounded border-l-4 border-green-400">
                            #5 æœ€ä½è‰¯ç‡ï¼Ÿ
                        </button>
                        
                        <p class="text-gray-500 font-medium mt-3">ä¸‰ã€äº‹ä»¶æŸ¥è©¢</p>
                        <button onclick="askQuestion('æ˜¯å¦æœ‰é€£çºŒæƒç¢¼çš„æƒ…æ³ï¼Ÿ')" class="w-full text-left p-2 bg-yellow-50 hover:bg-yellow-100 rounded border-l-4 border-yellow-400">
                            #6 é€£çºŒæƒç¢¼ï¼Ÿ
                        </button>
                        <button onclick="askQuestion('å…¥åº«ç¥¨å½±éŸ¿çš„ç®±è™Ÿæœ‰å“ªäº›ï¼Ÿ')" class="w-full text-left p-2 bg-yellow-50 hover:bg-yellow-100 rounded border-l-4 border-yellow-400">
                            #8 å…¥åº«ç¥¨è¿½æº¯ï¼Ÿ
                        </button>
                        
                        <p class="text-gray-500 font-medium mt-3">å››ã€å½±éŸ¿åˆ†æ</p>
                        <button onclick="askQuestion('å¦‚æœ907ç·šåœæ©Ÿ1å°æ™‚æœƒé€ æˆå¤šå¤§å½±éŸ¿ï¼Ÿ')" class="w-full text-left p-2 bg-orange-50 hover:bg-orange-100 rounded border-l-4 border-orange-400">
                            #9 åœæ©Ÿå½±éŸ¿ï¼Ÿ
                        </button>
                        
                        <p class="text-gray-500 font-medium mt-3">äº”ã€è¿½æº¯æŸ¥è©¢</p>
                        <button onclick="askQuestion('QR codeè¿½æº¯ï¼šç¶“æ­·å“ªäº›æ©Ÿå°ï¼Ÿ')" class="w-full text-left p-2 bg-red-50 hover:bg-red-100 rounded border-l-4 border-red-400">
                            #10 QRè¿½æº¯ï¼Ÿ
                        </button>
                    </div>
                </div>
            </div>

            <!-- å³å´ï¼šå°è©±å€ -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden flex flex-col" style="height: 700px;">
                    <!-- å°è©±æ­·å² -->
                    <div id="chatHistory" class="flex-1 overflow-y-auto p-4 space-y-4">
                        <div class="flex gap-3">
                            <div class="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center text-white flex-shrink-0">ğŸ¦Š</div>
                            <div class="chat-bubble bg-gray-100 rounded-xl p-4">
                                <p class="text-gray-800 font-medium">ä½ å¥½ï¼æˆ‘æ˜¯æ­£å´´ LLM æŸ¥è©¢å¹³å°ã€‚</p>
                                <p class="text-gray-600 text-sm mt-2">å·²é€£æ¥å¾Œç«¯è³‡æ–™åº«ï¼Œå¯å³æ™‚æŸ¥è©¢ç”Ÿç”¢æ•¸æ“šã€‚</p>
                                <p class="text-gray-500 text-xs mt-2">è©¦è©¦å·¦å´çš„å•é¡Œï¼Œæˆ–ç›´æ¥è¼¸å…¥ï¼</p>
                            </div>
                        </div>
                    </div>

                    <!-- è¼¸å…¥å€ -->
                    <div class="border-t p-4 bg-gray-50">
                        <div class="flex gap-2">
                            <input type="text" id="userInput" 
                                   placeholder="è¼¸å…¥å•é¡Œï¼Œä¾‹å¦‚ï¼šå„ç”¢ç·šè‰¯ç‡å¤šå°‘ï¼Ÿ" 
                                   class="flex-1 px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
                                   onkeypress="if(event.key==='Enter') sendMessage()">
                            <button onclick="sendMessage()" class="px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition">
                                ç™¼é€ â†’
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è¼‰å…¥çµ±è¨ˆ
        async function loadStats() {
            const res = await fetch('/api/stats');
            const data = await res.json();
            document.getElementById('stat-tables').textContent = data.table_count;
            document.getElementById('stat-rows').textContent = data.total_rows;
            document.getElementById('stat-lines').textContent = data.line_count;
            document.getElementById('stat-yield').textContent = data.avg_yield.toFixed(2);
        }
        loadStats();

        // å•é¡Œåˆ° API çš„æ˜ å°„
        const questionMapping = {
            'å¤šå°‘è¡¨': { api: '/api/stats', type: 'stats' },
            'è³‡æ–™æ•¸': { api: '/api/stats', type: 'stats' },
            'ç”Ÿç”¢ç·š': { api: '/api/line_comparison', type: 'lines' },
            'ç”¢èƒ½': { api: '/api/line_comparison', type: 'capacity' },
            'ä¸è‰¯ç‡': { api: '/api/line_comparison', type: 'defect' },
            'è‰¯ç‡': { api: '/api/line_comparison', type: 'yield' },
            'æœ€ä½': { api: '/api/lowest_yield', type: 'lowest' },
            'é€£çºŒæƒç¢¼': { api: '/api/scan_events', type: 'scan' },
            'å…¥åº«ç¥¨': { api: '/api/qr_trace', type: 'ticket' },
            'åœæ©Ÿ': { api: '/api/line_comparison', type: 'downtime' },
            'QR': { api: '/api/qr_trace', type: 'qr' },
            'è¿½æº¯': { api: '/api/qr_trace', type: 'trace' }
        };

        function askQuestion(q) {
            document.getElementById('userInput').value = q;
            sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const question = input.value.trim();
            if (!question) return;
            input.value = '';

            // é¡¯ç¤ºç”¨æˆ¶è¨Šæ¯
            addMessage(question, 'user');
            
            // é¡¯ç¤ºæ€è€ƒä¸­
            const thinkingId = addMessage('æ­£åœ¨æŸ¥è©¢è³‡æ–™åº«...', 'bot', true);

            // è§£æå•é¡Œï¼Œæ‰¾åˆ°å°æ‡‰çš„ API
            let apiInfo = { api: '/api/stats', type: 'stats' };
            for (const [key, value] of Object.entries(questionMapping)) {
                if (question.includes(key)) {
                    apiInfo = value;
                    break;
                }
            }

            try {
                const res = await fetch(apiInfo.api);
                const data = await res.json();
                
                // ç”Ÿæˆå›ç­”
                const answer = generateAnswer(question, data, apiInfo.type);
                
                // æ›´æ–°å›ç­”
                updateMessage(thinkingId, answer);
            } catch (err) {
                updateMessage(thinkingId, 'æŸ¥è©¢å¤±æ•—ï¼š' + err.message);
            }
        }

        function generateAnswer(question, data, type) {
            let answer = '';
            
            switch(type) {
                case 'stats':
                    answer = `### ğŸ“Š è³‡æ–™ç¸½è¦½

ç›®å‰è³‡æ–™åº«å…±æœ‰ **${data.table_count} å¼µè¡¨**ï¼Œç¸½è³‡æ–™ç­†æ•¸ç‚º **${data.total_rows}**ã€‚

- ç”Ÿç”¢ç·šæ•¸ï¼š${data.line_count} æ¢
- å¹³å‡è‰¯ç‡ï¼š${data.avg_yield.toFixed(2)}%`;
                    break;
                    
                case 'lines':
                case 'capacity':
                    answer = `### ğŸ­ ç”Ÿç”¢ç·šè³‡è¨Š

ç›®å‰å…±æœ‰ **${data.labels.length} æ¢ç”Ÿç”¢ç·š**ï¼š

| ç”¢ç·š | è‰¯ç‡ | ä¸è‰¯ç‡ |
|:-----|-----:|-------:|
${data.labels.map((l, i) => `| ${l} | ${data.yield_data[i]}% | ${data.defect_data[i]}% |`).join('\n')}`;
                    break;
                    
                case 'yield':
                case 'defect':
                    answer = `### ğŸ“ˆ è‰¯ç‡/ä¸è‰¯ç‡åˆ†æ

å„ç”¢ç·šè‰¯ç‡æ¯”è¼ƒï¼š

${data.labels.map((l, i) => `- **${l}**ï¼šè‰¯ç‡ ${data.yield_data[i]}%ï¼Œä¸è‰¯ç‡ ${data.defect_data[i]}%`).join('\n')}

å¹³å‡è‰¯ç‡ï¼š${(data.yield_data.reduce((a,b) => a+b, 0) / data.yield_data.length).toFixed(2)}%`;
                    break;
                    
                case 'lowest':
                    const records = data.records;
                    answer = `### ğŸ”» æœ€ä½è‰¯ç‡è¨˜éŒ„

è‰¯ç‡æœ€ä½çš„ TOP 5ï¼š

| æ’å | ç”¢ç·š | æ—¥æœŸ | è‰¯ç‡ | ä¸è‰¯ç‡ |
|:----:|:-----|:-----|-----:|-------:|
${records.slice(0, 5).map((r, i) => `| ${i+1} | ${r.line} | ${r.date} | ${r.yield}% | ${r.defect}% |`).join('\n')}

âš ï¸ æœ€ä½è¨˜éŒ„ï¼š**${records[0].line}** åœ¨ **${records[0].date}** è‰¯ç‡åƒ… **${records[0].yield}%**`;
                    break;
                    
                case 'scan':
                    answer = `### âš ï¸ é€£çºŒæƒç¢¼äº‹ä»¶

å„ç”¢ç·šé€£çºŒæƒç¢¼çµ±è¨ˆï¼š

${data.labels.map((l, i) => `- **${l}**ï¼š${data.data[i]} æ¬¡äº‹ä»¶`).join('\n')}

ç¸½è¨ˆï¼š${data.data.reduce((a,b) => a+b, 0)} æ¬¡é€£çºŒæƒç¢¼äº‹ä»¶`;
                    break;
                    
                case 'qr':
                case 'trace':
                case 'ticket':
                    answer = `### ğŸ” QR è¿½æº¯çµ±è¨ˆ

è¿½æº¯çµæœåˆ†ä½ˆï¼š

${data.labels.map((l, i) => `- **${l}**ï¼š${data.data[i]} ç­†`).join('\n')}

ç¸½è¿½æº¯è¨˜éŒ„ï¼š${data.data.reduce((a,b) => a+b, 0)} ç­†`;
                    break;
                    
                case 'downtime':
                    const total = data.output_data.reduce((a,b) => a+b, 0);
                    const hourly = Math.round(total / 732 / 24);
                    answer = `### â±ï¸ åœæ©Ÿå½±éŸ¿åˆ†æ

ä»¥ **907 ç·š**ç‚ºä¾‹ï¼Œè‹¥åœæ©Ÿ 1 å°æ™‚ï¼š

- é ä¼°æå¤±ç”¢èƒ½ï¼šç´„ **${hourly.toLocaleString()}** ä»¶
- ä½”æ—¥ç”¢èƒ½æ¯”ä¾‹ï¼šç´„ **4.17%**

å„ç”¢ç·šç¸½ç”¢èƒ½ï¼š
${data.labels.map((l, i) => `- ${l}ï¼š${data.output_data[i].toLocaleString()} ä»¶`).join('\n')}`;
                    break;
                    
                default:
                    answer = `å·²æ”¶åˆ°å•é¡Œï¼šã€Œ${question}ã€\n\nè«‹å˜—è©¦æ›´å…·é«”çš„å•é¡Œï¼Œæˆ–ä½¿ç”¨å·¦å´çš„å•é¡Œç¯„ä¾‹ã€‚`;
            }
            
            return answer;
        }

        function addMessage(content, sender, isThinking = false) {
            const chatHistory = document.getElementById('chatHistory');
            const id = 'msg-' + Date.now();
            
            const html = sender === 'user' 
                ? `<div class="flex gap-3 justify-end fade-in">
                       <div class="chat-bubble bg-orange-500 text-white rounded-xl p-4">
                           <p>${content}</p>
                       </div>
                       <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center flex-shrink-0">ğŸ‘¤</div>
                   </div>`
                : `<div id="${id}" class="flex gap-3 fade-in">
                       <div class="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center text-white flex-shrink-0">ğŸ¦Š</div>
                       <div class="chat-bubble bg-gray-100 rounded-xl p-4">
                           <div class="text-gray-800 whitespace-pre-wrap ${isThinking ? 'typing-indicator' : ''}">${isThinking ? content : formatMarkdown(content)}</div>
                       </div>
                   </div>`;
            
            chatHistory.insertAdjacentHTML('beforeend', html);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            return id;
        }

        function updateMessage(id, content) {
            const el = document.querySelector(`#${id} .chat-bubble div`);
            if (el) {
                el.classList.remove('typing-indicator');
                el.innerHTML = formatMarkdown(content);
            }
        }

        function formatMarkdown(text) {
            return text
                .replace(/### (.*)/g, '<h3 class="font-bold text-lg mb-2">$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n\n/g, '</p><p class="mt-2">')
                .replace(/\n/g, '<br>')
                .replace(/\|(.+)\|/g, (match) => {
                    const cells = match.split('|').filter(c => c.trim());
                    if (cells[0].includes('---')) return '';
                    return '<tr>' + cells.map(c => `<td class="px-2 py-1 border">${c.trim()}</td>`).join('') + '</tr>';
                })
                .replace(/(<tr>.*<\/tr>)+/g, '<table class="text-sm border-collapse my-2">$&</table>')
                .replace(/- \*\*(.*?)\*\*ï¼š(.*)/g, '<li><strong>$1</strong>ï¼š$2</li>')
                .replace(/- (.*)/g, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)+/g, '<ul class="list-disc list-inside my-2">$&</ul>');
        }
    </script>
</body>
</html>
