<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM æŸ¥è©¢ç³»çµ± v3.3 | æ­£å´´ PoC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .fade-in { animation: fadeIn 0.4s ease; }
        .pulse { animation: pulse 1.5s infinite; }
        .chat-bubble { max-width: 90%; }
        
        /* å›ç­”å…§å®¹æ¨£å¼ */
        .answer-box { background: #f8fafc; border-radius: 16px; padding: 20px; }
        .answer-title { font-size: 16px; font-weight: 700; color: #1e293b; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
        .answer-title::before { content: ''; width: 4px; height: 24px; background: linear-gradient(180deg, #f97316, #ea580c); border-radius: 2px; }
        
        /* æ•¸æ“šå¡ç‰‡ */
        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin: 16px 0; }
        .stat-item { background: linear-gradient(135deg, #fff7ed, #ffedd5); border: 1px solid #fed7aa; border-radius: 12px; padding: 14px; }
        .stat-item .label { font-size: 11px; color: #9a3412; font-weight: 500; text-transform: uppercase; }
        .stat-item .value { font-size: 24px; font-weight: 700; color: #c2410c; margin-top: 4px; }
        .stat-item .unit { font-size: 12px; color: #ea580c; font-weight: 500; }
        
        /* è¡¨æ ¼ */
        .data-table { width: 100%; border-collapse: collapse; margin: 16px 0; font-size: 13px; border-radius: 12px; overflow: hidden; }
        .data-table thead { background: linear-gradient(135deg, #1e293b, #334155); }
        .data-table th { color: white; padding: 12px 14px; text-align: left; font-weight: 600; font-size: 12px; }
        .data-table td { padding: 12px 14px; border-bottom: 1px solid #e2e8f0; background: white; }
        .data-table tr:hover td { background: #fff7ed; }
        .data-table tr:last-child td { border-bottom: none; }
        
        /* å¾½ç«  */
        .badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
        .badge-green { background: #dcfce7; color: #166534; }
        .badge-yellow { background: #fef3c7; color: #92400e; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
        
        /* åœ–è¡¨ */
        .chart-box { background: white; border-radius: 12px; padding: 16px; margin: 16px 0; border: 1px solid #e2e8f0; }
        .chart-box canvas { max-height: 220px; }
        
        /* æ´å¯Ÿæ¡† */
        .insight-box { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 1px solid #fbbf24; border-radius: 12px; padding: 14px; margin: 16px 0; display: flex; gap: 12px; }
        .insight-box.alert { background: linear-gradient(135deg, #fee2e2, #fecaca); border-color: #f87171; }
        .insight-box .icon { font-size: 20px; flex-shrink: 0; }
        .insight-box .title { font-weight: 700; color: #92400e; font-size: 13px; }
        .insight-box.alert .title { color: #991b1b; }
        .insight-box .text { color: #78350f; font-size: 13px; margin-top: 2px; line-height: 1.5; }
        .insight-box.alert .text { color: #7f1d1d; }
        
        /* SQL */
        .sql-box { background: #1e293b; border-radius: 8px; padding: 12px 16px; margin-top: 16px; font-family: 'Fira Code', monospace; font-size: 11px; color: #94a3b8; overflow-x: auto; }
        .sql-box code { color: #e2e8f0; }
        .sql-toggle { font-size: 12px; color: #64748b; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; margin-top: 12px; }
        .sql-toggle:hover { color: #f97316; }
        
        /* é€²åº¦æ¢ */
        .progress-row { display: flex; align-items: center; gap: 12px; padding: 8px 0; }
        .progress-row .name { width: 60px; font-weight: 600; font-size: 13px; color: #1e293b; }
        .progress-row .bar { flex: 1; height: 24px; background: #e2e8f0; border-radius: 6px; overflow: hidden; position: relative; }
        .progress-row .fill { height: 100%; border-radius: 6px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; font-size: 11px; font-weight: 600; color: white; }
        .progress-row .value { width: 80px; text-align: right; font-size: 13px; color: #64748b; }
        
        /* å•é¡ŒæŒ‰éˆ• */
        .q-btn { transition: all 0.2s; border: 1px solid transparent; }
        .q-btn:hover { transform: translateX(4px); border-color: currentColor; }
    </style>
</head>
<body class="min-h-screen bg-gray-100">
    <!-- é ‚éƒ¨ -->
    <nav class="bg-gradient-to-r from-orange-600 to-orange-500 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold flex items-center gap-2">ğŸ¦Š FoxLink LLM æŸ¥è©¢å¹³å°</h1>
                    <p class="text-xs text-orange-100">æ­£å´´ PoC v3.3 Â· DB é©…å‹•æ™ºèƒ½æŸ¥è©¢</p>
                </div>
                <div class="flex gap-3">
                    <a href="/" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm transition">ğŸ“Š Dashboard</a>
                    <span class="px-3 py-2 bg-green-500 rounded-lg text-xs font-bold flex items-center gap-1">
                        <span class="w-2 h-2 bg-white rounded-full pulse"></span> Live
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- é ‚éƒ¨çµ±è¨ˆ -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow p-4 border-l-4 border-blue-500">
                <p class="text-gray-500 text-xs">è³‡æ–™è¡¨</p>
                <p class="text-2xl font-bold text-blue-600" id="s-tables">-</p>
            </div>
            <div class="bg-white rounded-xl shadow p-4 border-l-4 border-green-500">
                <p class="text-gray-500 text-xs">ç¸½è³‡æ–™</p>
                <p class="text-xl font-bold text-green-600" id="s-rows">-</p>
            </div>
            <div class="bg-white rounded-xl shadow p-4 border-l-4 border-purple-500">
                <p class="text-gray-500 text-xs">ç”¢ç·š</p>
                <p class="text-2xl font-bold text-purple-600" id="s-lines">-</p>
            </div>
            <div class="bg-white rounded-xl shadow p-4 border-l-4 border-orange-500">
                <p class="text-gray-500 text-xs">è‰¯ç‡</p>
                <p class="text-2xl font-bold text-orange-600"><span id="s-yield">-</span>%</p>
            </div>
        </div>

        <div class="grid lg:grid-cols-4 gap-6">
            <!-- å·¦å´å•é¡Œ -->
            <div class="lg:col-span-1 space-y-4">
                <div class="bg-white rounded-xl shadow-lg p-4">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">ğŸ’¡ æ™ºèƒ½å•ç­”</h3>
                    <div class="space-y-2 text-xs">
                        <p class="text-gray-400 font-medium text-[10px] uppercase tracking-wider">è³‡æ–™ç¸½è¦½</p>
                        <button onclick="ask('è³‡æ–™åº«æœ‰å¤šå°‘è¡¨ï¼Ÿç¸½è³‡æ–™é‡ï¼Ÿ')" class="q-btn w-full text-left p-2.5 bg-blue-50 text-blue-700 rounded-lg border-l-4 border-blue-400">ğŸ“Š è³‡æ–™è¡¨ç¸½è¦½</button>
                        <button onclick="ask('å» æˆ¿æœ‰å¤šå°‘ç”Ÿç”¢ç·šï¼Ÿ')" class="q-btn w-full text-left p-2.5 bg-blue-50 text-blue-700 rounded-lg border-l-4 border-blue-400">ğŸ­ ç”Ÿç”¢ç·šè³‡è¨Š</button>
                        
                        <p class="text-gray-400 font-medium text-[10px] uppercase tracking-wider mt-3">ç”Ÿç”¢åˆ†æ</p>
                        <button onclick="ask('å„ç”¢ç·šè‰¯ç‡ä¸è‰¯ç‡åˆ†æ')" class="q-btn w-full text-left p-2.5 bg-green-50 text-green-700 rounded-lg border-l-4 border-green-400">ğŸ“ˆ è‰¯ç‡åˆ†æ</button>
                        <button onclick="ask('å“ªæ¢ç·šè‰¯ç‡æœ€ä½ï¼Ÿ')" class="q-btn w-full text-left p-2.5 bg-green-50 text-green-700 rounded-lg border-l-4 border-green-400">ğŸ”» æœ€ä½è‰¯ç‡</button>
                        <button onclick="ask('å„ç”¢ç·šç”¢èƒ½æ¯”è¼ƒ')" class="q-btn w-full text-left p-2.5 bg-green-50 text-green-700 rounded-lg border-l-4 border-green-400">âš¡ ç”¢èƒ½åˆ†æ</button>
                        
                        <p class="text-gray-400 font-medium text-[10px] uppercase tracking-wider mt-3">ç•°å¸¸è¿½è¹¤</p>
                        <button onclick="ask('é€£çºŒæƒç¢¼ç•°å¸¸åˆ†æ')" class="q-btn w-full text-left p-2.5 bg-yellow-50 text-yellow-700 rounded-lg border-l-4 border-yellow-400">âš ï¸ é€£çºŒæƒç¢¼</button>
                        <button onclick="ask('QRè¿½æº¯çµ±è¨ˆ')" class="q-btn w-full text-left p-2.5 bg-yellow-50 text-yellow-700 rounded-lg border-l-4 border-yellow-400">ğŸ” QR è¿½æº¯</button>
                        
                        <p class="text-gray-400 font-medium text-[10px] uppercase tracking-wider mt-3">å½±éŸ¿è©•ä¼°</p>
                        <button onclick="ask('åœæ©Ÿ1å°æ™‚å½±éŸ¿å¤šå¤§ï¼Ÿ')" class="q-btn w-full text-left p-2.5 bg-red-50 text-red-700 rounded-lg border-l-4 border-red-400">â±ï¸ åœæ©Ÿå½±éŸ¿</button>
                    </div>
                </div>
            </div>

            <!-- å°è©±å€ -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden flex flex-col" style="height: 720px;">
                    <div id="chat" class="flex-1 overflow-y-auto p-6 space-y-6">
                        <!-- æ­¡è¿ -->
                        <div class="flex gap-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl flex items-center justify-center text-white text-xl flex-shrink-0 shadow-lg">ğŸ¦Š</div>
                            <div class="chat-bubble bg-gray-50 rounded-2xl p-5">
                                <p class="text-gray-800 font-semibold text-lg">ä½ å¥½ï¼æˆ‘æ˜¯æ­£å´´ LLM æ™ºèƒ½æŸ¥è©¢åŠ©æ‰‹</p>
                                <p class="text-gray-500 text-sm mt-2">å·²é€£æ¥ç”Ÿç”¢è³‡æ–™åº«ï¼Œæ”¯æ´å³æ™‚æŸ¥è©¢èˆ‡è¦–è¦ºåŒ–åˆ†æã€‚</p>
                                <div class="flex gap-2 mt-4">
                                    <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs">åœ–è¡¨åˆ†æ</span>
                                    <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs">æ•¸æ“šè¡¨æ ¼</span>
                                    <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs">SQL æŸ¥è©¢</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è¼¸å…¥ -->
                    <div class="border-t p-4 bg-gray-50">
                        <div class="flex gap-3">
                            <input type="text" id="input" placeholder="è¼¸å…¥å•é¡Œ..." 
                                   class="flex-1 px-5 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500"
                                   onkeypress="if(event.key==='Enter') send()">
                            <button onclick="send()" class="px-8 py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl hover:shadow-lg transition font-medium">ç™¼é€ â†’</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chartId = 0;
        
        // è¼‰å…¥çµ±è¨ˆ
        fetch('/api/stats').then(r => r.json()).then(d => {
            document.getElementById('s-tables').textContent = d.table_count;
            document.getElementById('s-rows').textContent = d.total_rows;
            document.getElementById('s-lines').textContent = d.line_count;
            document.getElementById('s-yield').textContent = d.avg_yield.toFixed(2);
        });

        function ask(q) { document.getElementById('input').value = q; send(); }

        async function send() {
            const input = document.getElementById('input');
            const q = input.value.trim();
            if (!q) return;
            input.value = '';

            addUser(q);
            const loading = addLoading();

            await new Promise(r => setTimeout(r, 600));

            try {
                const result = await query(q);
                loading.remove();
                addBot(result);
            } catch (e) {
                loading.remove();
                addBot({ type: 'error', msg: e.message });
            }
        }

        async function query(q) {
            const ql = q.toLowerCase();
            
            if (ql.includes('è¡¨') || ql.includes('è³‡æ–™é‡') || ql.includes('ç¸½è¦½')) {
                return { type: 'stats', data: await fetch('/api/stats').then(r => r.json()) };
            }
            if (ql.includes('è‰¯ç‡') || ql.includes('ä¸è‰¯ç‡') || ql.includes('ç”¢ç·š')) {
                return { type: 'yield', data: await fetch('/api/line_comparison').then(r => r.json()) };
            }
            if (ql.includes('æœ€ä½') || ql.includes('æœ€å·®')) {
                return { type: 'lowest', data: await fetch('/api/lowest_yield').then(r => r.json()) };
            }
            if (ql.includes('ç”¢èƒ½')) {
                return { type: 'capacity', data: await fetch('/api/capacity_distribution').then(r => r.json()) };
            }
            if (ql.includes('æƒç¢¼') || ql.includes('ç•°å¸¸')) {
                return { type: 'scan', data: await fetch('/api/scan_events').then(r => r.json()) };
            }
            if (ql.includes('qr') || ql.includes('è¿½æº¯')) {
                return { type: 'qr', data: await fetch('/api/qr_trace').then(r => r.json()) };
            }
            if (ql.includes('åœæ©Ÿ') || ql.includes('å½±éŸ¿')) {
                return { type: 'downtime', data: await fetch('/api/line_comparison').then(r => r.json()) };
            }
            return { type: 'help', q };
        }

        function addUser(text) {
            const chat = document.getElementById('chat');
            chat.insertAdjacentHTML('beforeend', `
                <div class="flex gap-4 justify-end fade-in">
                    <div class="chat-bubble bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-2xl p-4 shadow-lg">
                        <p>${esc(text)}</p>
                    </div>
                    <div class="w-12 h-12 bg-gray-200 rounded-xl flex items-center justify-center text-xl flex-shrink-0">ğŸ‘¤</div>
                </div>
            `);
            chat.scrollTop = chat.scrollHeight;
        }

        function addLoading() {
            const chat = document.getElementById('chat');
            const div = document.createElement('div');
            div.className = 'flex gap-4 fade-in';
            div.innerHTML = `
                <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl flex items-center justify-center text-white text-xl flex-shrink-0 shadow-lg">ğŸ¦Š</div>
                <div class="chat-bubble bg-gray-50 rounded-2xl p-5">
                    <div class="flex items-center gap-3">
                        <div class="flex gap-1">
                            <span class="w-2 h-2 bg-orange-500 rounded-full pulse"></span>
                            <span class="w-2 h-2 bg-orange-500 rounded-full pulse" style="animation-delay:0.2s"></span>
                            <span class="w-2 h-2 bg-orange-500 rounded-full pulse" style="animation-delay:0.4s"></span>
                        </div>
                        <span class="text-gray-500 text-sm">æ­£åœ¨æŸ¥è©¢è³‡æ–™åº«...</span>
                    </div>
                </div>
            `;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
            return div;
        }

        function addBot(r) {
            const chat = document.getElementById('chat');
            const html = render(r);
            chat.insertAdjacentHTML('beforeend', `
                <div class="flex gap-4 fade-in">
                    <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl flex items-center justify-center text-white text-xl flex-shrink-0 shadow-lg">ğŸ¦Š</div>
                    <div class="chat-bubble flex-1">${html}</div>
                </div>
            `);
            chat.scrollTop = chat.scrollHeight;
            setTimeout(renderCharts, 50);
        }

        function render(r) {
            const { type, data } = r;
            let h = '<div class="answer-box">';

            switch(type) {
                case 'stats':
                    h += `
                        <div class="answer-title">ğŸ“Š è³‡æ–™åº«ç¸½è¦½</div>
                        <div class="stat-grid">
                            <div class="stat-item"><div class="label">è³‡æ–™è¡¨</div><div class="value">${data.table_count}<span class="unit"> å¼µ</span></div></div>
                            <div class="stat-item"><div class="label">ç¸½è³‡æ–™é‡</div><div class="value" style="font-size:18px">${data.total_rows}</div></div>
                            <div class="stat-item"><div class="label">ç”Ÿç”¢ç·š</div><div class="value">${data.line_count}<span class="unit"> æ¢</span></div></div>
                            <div class="stat-item"><div class="label">å¹³å‡è‰¯ç‡</div><div class="value">${data.avg_yield.toFixed(2)}<span class="unit">%</span></div></div>
                        </div>
                        <div class="insight-box">
                            <span class="icon">ğŸ’¡</span>
                            <div><div class="title">æ•¸æ“šæ´å¯Ÿ</div><div class="text">ç³»çµ±æ•´åˆ ${data.table_count} å¼µè¡¨ã€è¶…é <strong>15 å„„ç­†</strong>ç”Ÿç”¢æ•¸æ“šï¼Œæ”¯æ´å³æ™‚æŸ¥è©¢èˆ‡åˆ†æã€‚</div></div>
                        </div>
                    `;
                    h += sqlBlock(`SELECT COUNT(*) FROM _table_catalog;\nSELECT SUM(row_count) FROM _table_catalog;`);
                    break;

                case 'yield':
                    const cid1 = 'c' + (++chartId);
                    h += `
                        <div class="answer-title">ğŸ“ˆ è‰¯ç‡åˆ†æ</div>
                        <p class="text-gray-600 text-sm mb-4">å…± <strong>${data.labels.length}</strong> æ¢ç”¢ç·šï¼Œä»¥ä¸‹ç‚ºè‰¯ç‡èˆ‡ä¸è‰¯ç‡æ¯”è¼ƒï¼š</p>
                        <div class="chart-box"><canvas id="${cid1}" data-type="bar" data-labels='${JSON.stringify(data.labels)}' data-d1='${JSON.stringify(data.yield_data)}' data-d2='${JSON.stringify(data.defect_data)}'></canvas></div>
                        <table class="data-table">
                            <thead><tr><th>ç”¢ç·š</th><th>è‰¯ç‡</th><th>ä¸è‰¯ç‡</th><th>ç‹€æ…‹</th></tr></thead>
                            <tbody>${data.labels.map((l,i) => `<tr><td><strong>${l}</strong></td><td>${data.yield_data[i]}%</td><td>${data.defect_data[i]}%</td><td>${badge(data.yield_data[i])}</td></tr>`).join('')}</tbody>
                        </table>
                    `;
                    h += sqlBlock(`SELECT line_no, AVG(yield_rate)*100, AVG(defect_rate)*100\nFROM daily_capacity GROUP BY line_no;`);
                    break;

                case 'lowest':
                    const recs = data.records;
                    h += `
                        <div class="answer-title">ğŸ”» æœ€ä½è‰¯ç‡è¿½è¹¤</div>
                        <div class="insight-box alert">
                            <span class="icon">âš ï¸</span>
                            <div><div class="title">è­¦ç¤º</div><div class="text">æœ€ä½è¨˜éŒ„ï¼š<strong>${recs[0].line}</strong> åœ¨ <strong>${recs[0].date}</strong> è‰¯ç‡åƒ… <strong>${recs[0].yield}%</strong></div></div>
                        </div>
                        <table class="data-table">
                            <thead><tr><th>æ’å</th><th>ç”¢ç·š</th><th>æ—¥æœŸ</th><th>è‰¯ç‡</th><th>ä¸è‰¯ç‡</th></tr></thead>
                            <tbody>${recs.slice(0,8).map((r,i) => `<tr><td><span class="badge ${i<3?'badge-red':'badge-yellow'}">#${i+1}</span></td><td><strong>${r.line}</strong></td><td>${r.date}</td><td>${r.yield}%</td><td>${r.defect}%</td></tr>`).join('')}</tbody>
                        </table>
                    `;
                    h += sqlBlock(`SELECT line_no, date, yield_rate, defect_rate\nFROM daily_capacity ORDER BY yield_rate LIMIT 10;`);
                    break;

                case 'capacity':
                    const cid2 = 'c' + (++chartId);
                    const total = data.data.reduce((a,b)=>a+b,0);
                    h += `
                        <div class="answer-title">âš¡ ç”¢èƒ½åˆ†æ</div>
                        <div class="chart-box"><canvas id="${cid2}" data-type="doughnut" data-labels='${JSON.stringify(data.labels)}' data-values='${JSON.stringify(data.data)}'></canvas></div>
                        <div class="mt-4 space-y-2">
                            ${data.labels.map((l,i) => {
                                const pct = (data.data[i]/total*100).toFixed(1);
                                const colors = ['#4ade80','#60a5fa','#fbbf24','#f87171'];
                                return `<div class="progress-row">
                                    <div class="name">${l}</div>
                                    <div class="bar"><div class="fill" style="width:${pct}%;background:${colors[i%4]}">${pct}%</div></div>
                                    <div class="value">${(data.data[i]/1e6).toFixed(1)}M</div>
                                </div>`;
                            }).join('')}
                        </div>
                    `;
                    h += sqlBlock(`SELECT line_no, SUM(total_good)\nFROM daily_capacity GROUP BY line_no;`);
                    break;

                case 'scan':
                    const cid3 = 'c' + (++chartId);
                    const totalScan = data.data.reduce((a,b)=>a+b,0);
                    h += `
                        <div class="answer-title">âš ï¸ é€£çºŒæƒç¢¼äº‹ä»¶</div>
                        <p class="text-gray-600 text-sm mb-4">é€£çºŒæƒç¢¼å¯èƒ½ä»£è¡¨é‡å·¥æˆ–æ“ä½œç•°å¸¸ï¼š</p>
                        <div class="chart-box"><canvas id="${cid3}" data-type="hbar" data-labels='${JSON.stringify(data.labels)}' data-values='${JSON.stringify(data.data)}'></canvas></div>
                        <div class="insight-box">
                            <span class="icon">ğŸ“‹</span>
                            <div><div class="title">çµ±è¨ˆæ‘˜è¦</div><div class="text">å…± <strong>${totalScan}</strong> æ¬¡é€£çºŒæƒç¢¼äº‹ä»¶ï¼Œåˆ†ä½ˆæ–¼ ${data.labels.length} æ¢ç”¢ç·šã€‚</div></div>
                        </div>
                    `;
                    h += sqlBlock(`SELECT line_no, COUNT(*)\nFROM scan_continuous_summary GROUP BY line_no;`);
                    break;

                case 'qr':
                    const cid4 = 'c' + (++chartId);
                    const totalQR = data.data.reduce((a,b)=>a+b,0);
                    h += `
                        <div class="answer-title">ğŸ” QR è¿½æº¯çµ±è¨ˆ</div>
                        <div class="chart-box"><canvas id="${cid4}" data-type="pie" data-labels='${JSON.stringify(data.labels)}' data-values='${JSON.stringify(data.data)}'></canvas></div>
                        <table class="data-table">
                            <thead><tr><th>çµæœ</th><th>æ•¸é‡</th><th>ä½”æ¯”</th></tr></thead>
                            <tbody>${data.labels.map((l,i) => `<tr><td><span class="badge ${l==='OK'?'badge-green':'badge-red'}">${l}</span></td><td>${data.data[i]}</td><td>${(data.data[i]/totalQR*100).toFixed(1)}%</td></tr>`).join('')}</tbody>
                        </table>
                    `;
                    h += sqlBlock(`SELECT result, COUNT(*)\nFROM qr_trace_index GROUP BY result;`);
                    break;

                case 'downtime':
                    const totalOut = data.output_data.reduce((a,b)=>a+b,0);
                    const avgH = Math.round(totalOut/732/24/data.labels.length);
                    h += `
                        <div class="answer-title">â±ï¸ åœæ©Ÿå½±éŸ¿åˆ†æ</div>
                        <div class="insight-box">
                            <span class="icon">âš¡</span>
                            <div><div class="title">å½±éŸ¿è©•ä¼°</div><div class="text">è‹¥ä»»ä¸€ç”¢ç·šåœæ©Ÿ <strong>1 å°æ™‚</strong>ï¼š</div></div>
                        </div>
                        <div class="stat-grid" style="grid-template-columns:repeat(3,1fr)">
                            <div class="stat-item"><div class="label">æå¤±ç”¢èƒ½</div><div class="value" style="font-size:20px">${avgH.toLocaleString()}<span class="unit">ä»¶</span></div></div>
                            <div class="stat-item"><div class="label">ä½”æ—¥ç”¢èƒ½</div><div class="value" style="font-size:20px">~4.2<span class="unit">%</span></div></div>
                            <div class="stat-item"><div class="label">å»ºè­°</div><div class="value" style="font-size:16px;color:#dc2626">ç«‹å³æ’é™¤</div></div>
                        </div>
                        <p class="text-gray-600 text-sm mt-4 font-medium">å„ç”¢ç·šå°æ™‚ç”¢èƒ½ï¼š</p>
                        <div class="mt-2 space-y-1">
                            ${data.labels.map((l,i) => {
                                const h = Math.round(data.output_data[i]/732/24);
                                return `<div class="flex justify-between py-1 border-b border-gray-100"><span class="font-medium">${l}</span><span class="text-gray-500">${h.toLocaleString()} ä»¶/hr</span></div>`;
                            }).join('')}
                        </div>
                    `;
                    h += sqlBlock(`SELECT line_no, SUM(total_good)/732/24\nFROM daily_capacity GROUP BY line_no;`);
                    break;

                case 'error':
                    h += `<div class="insight-box alert"><span class="icon">âŒ</span><div><div class="title">éŒ¯èª¤</div><div class="text">${r.msg}</div></div></div>`;
                    break;

                default:
                    h += `
                        <div class="answer-title">ğŸ¤” å¦‚ä½•å¹«åŠ©æ‚¨ï¼Ÿ</div>
                        <p class="text-gray-600 text-sm mb-3">æ‚¨å•çš„æ˜¯ï¼šã€Œ${esc(r.q || '')}ã€</p>
                        <p class="text-gray-600 text-sm mb-2">æ”¯æ´çš„æŸ¥è©¢é¡å‹ï¼š</p>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="p-2 bg-blue-50 rounded-lg text-blue-700">ğŸ“Š è³‡æ–™ç¸½è¦½</div>
                            <div class="p-2 bg-green-50 rounded-lg text-green-700">ğŸ“ˆ è‰¯ç‡åˆ†æ</div>
                            <div class="p-2 bg-green-50 rounded-lg text-green-700">ğŸ”» æœ€ä½è‰¯ç‡</div>
                            <div class="p-2 bg-green-50 rounded-lg text-green-700">âš¡ ç”¢èƒ½åˆ†æ</div>
                            <div class="p-2 bg-yellow-50 rounded-lg text-yellow-700">âš ï¸ é€£çºŒæƒç¢¼</div>
                            <div class="p-2 bg-yellow-50 rounded-lg text-yellow-700">ğŸ” QR è¿½æº¯</div>
                            <div class="p-2 bg-red-50 rounded-lg text-red-700">â±ï¸ åœæ©Ÿå½±éŸ¿</div>
                        </div>
                    `;
            }
            h += '</div>';
            return h;
        }

        function badge(v) {
            if (v >= 96) return '<span class="badge badge-green">å„ªè‰¯</span>';
            if (v >= 94) return '<span class="badge badge-blue">æ­£å¸¸</span>';
            if (v >= 90) return '<span class="badge badge-yellow">æ³¨æ„</span>';
            return '<span class="badge badge-red">è­¦ç¤º</span>';
        }

        function sqlBlock(sql) {
            return `<details class="mt-4"><summary class="sql-toggle">ğŸ”§ æŸ¥çœ‹ SQL</summary><div class="sql-box"><code>${esc(sql)}</code></div></details>`;
        }

        function esc(s) {
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        function renderCharts() {
            document.querySelectorAll('canvas[data-type]').forEach(c => {
                if (c.rendered) return;
                c.rendered = true;
                const t = c.dataset.type;
                const labels = JSON.parse(c.dataset.labels || '[]');
                let cfg = {};

                if (t === 'bar') {
                    cfg = {
                        type: 'bar',
                        data: { labels, datasets: [
                            { label: 'è‰¯ç‡%', data: JSON.parse(c.dataset.d1), backgroundColor: '#4ade80' },
                            { label: 'ä¸è‰¯ç‡%', data: JSON.parse(c.dataset.d2), backgroundColor: '#f87171' }
                        ]},
                        options: { responsive: true, maintainAspectRatio: false }
                    };
                } else if (t === 'doughnut' || t === 'pie') {
                    cfg = {
                        type: t,
                        data: { labels, datasets: [{ data: JSON.parse(c.dataset.values), backgroundColor: ['#4ade80','#60a5fa','#fbbf24','#f87171'] }] },
                        options: { responsive: true, maintainAspectRatio: false }
                    };
                } else if (t === 'hbar') {
                    cfg = {
                        type: 'bar',
                        data: { labels, datasets: [{ label: 'äº‹ä»¶æ•¸', data: JSON.parse(c.dataset.values), backgroundColor: '#f97316' }] },
                        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
                    };
                }
                if (cfg.type) new Chart(c, cfg);
            });
        }
    </script>
</body>
</html>
